<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-02-18">

<title>EKS Cluster build – IBM Quantum Safe Encryption</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../src/guardium_insights/03_gi-install.html" rel="next">
<link href="../../../src/guardium_insights/eks/01_pre-reqs.html" rel="prev">
<link href="../../../images/bee.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-0e5edbee8f245697e4c7aae403c32e64.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": true,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "Search",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../images/IBMlogo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">IBM Quantum Safe Encryption</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/ibm-client-engineering">
 <span class="dropdown-text">Check us out on Github</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.ibm.com/ibm-client-engineering/solution-journal-quantum-safe">
 <span class="dropdown-text">Look at this repo on Github</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-linkedin" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-linkedin">    
        <li>
    <a class="dropdown-item" href="http://linkedin.com/post">
 <span class="dropdown-text">Share on your LinkedIn</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.linkedin.com/company/ibm/">
 <span class="dropdown-text">IBM LinkedIn</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Guardium Insights</li><li class="breadcrumb-item"><a href="../../../src/guardium_insights/eks/01_pre-reqs.html">EKS</a></li><li class="breadcrumb-item"><a href="../../../src/guardium_insights/eks/02_cluster-build.html">EKS Cluster Build</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Definition</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">QSR</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Adaptive Proxy</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qsr/adaptive_proxy/01_installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qsr/adaptive_proxy/02_configuration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configuration</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Performance Test Harness</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qsr/performance_test_harness/01_installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qsr/performance_test_harness/02_usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Usage</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">QSE</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qse/01_installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qse/02_scanning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scanning</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Guardium Insights</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">EC2</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/ec2/01-prereqs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prerequisites</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/ec2/02-preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preparation</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">EKS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/eks/01_pre-reqs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prerequisites</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/eks/02_cluster-build.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">EKS Cluster Build</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/03_gi-install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Guardium Insights Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/04_optional_services.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optional Services</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/key-takeaway.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Key Takeaways</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#creating-the-cluster" id="toc-creating-the-cluster" class="nav-link active" data-scroll-target="#creating-the-cluster">Creating the cluster</a></li>
  <li><a href="#configure-kubectl" id="toc-configure-kubectl" class="nav-link" data-scroll-target="#configure-kubectl">Configure <code>kubectl</code></a></li>
  <li><a href="#install-the-ebs-driver-to-the-cluster" id="toc-install-the-ebs-driver-to-the-cluster" class="nav-link" data-scroll-target="#install-the-ebs-driver-to-the-cluster">Install the EBS driver to the cluster</a>
  <ul class="collapse">
  <li><a href="#verifying-ebs" id="toc-verifying-ebs" class="nav-link" data-scroll-target="#verifying-ebs">Verifying EBS</a></li>
  </ul></li>
  <li><a href="#enable-efs-on-the-cluster" id="toc-enable-efs-on-the-cluster" class="nav-link" data-scroll-target="#enable-efs-on-the-cluster">Enable EFS on the cluster</a>
  <ul class="collapse">
  <li><a href="#create-iam-policy" id="toc-create-iam-policy" class="nav-link" data-scroll-target="#create-iam-policy">Create IAM policy</a></li>
  <li><a href="#create-iam-role" id="toc-create-iam-role" class="nav-link" data-scroll-target="#create-iam-role">Create IAM role</a></li>
  <li><a href="#install-efs-csi-driver" id="toc-install-efs-csi-driver" class="nav-link" data-scroll-target="#install-efs-csi-driver">Install EFS CSI driver</a></li>
  <li><a href="#create-the-efs-filesystem" id="toc-create-the-efs-filesystem" class="nav-link" data-scroll-target="#create-the-efs-filesystem">Create the EFS Filesystem</a></li>
  <li><a href="#create-efs-storage-class" id="toc-create-efs-storage-class" class="nav-link" data-scroll-target="#create-efs-storage-class">Create EFS Storage Class</a></li>
  <li><a href="#verify-efs" id="toc-verify-efs" class="nav-link" data-scroll-target="#verify-efs">Verify EFS</a></li>
  </ul></li>
  <li><a href="#install-nginx-controller" id="toc-install-nginx-controller" class="nav-link" data-scroll-target="#install-nginx-controller">Install NGINX Controller</a>
  <ul class="collapse">
  <li><a href="#verify-the-nginx-deployment" id="toc-verify-the-nginx-deployment" class="nav-link" data-scroll-target="#verify-the-nginx-deployment">Verify the NGINX deployment</a></li>
  </ul></li>
  <li><a href="#install-the-operator-lifecycle-manager" id="toc-install-the-operator-lifecycle-manager" class="nav-link" data-scroll-target="#install-the-operator-lifecycle-manager">Install the Operator Lifecycle Manager</a></li>
  <li><a href="#create-the-required-namespace" id="toc-create-the-required-namespace" class="nav-link" data-scroll-target="#create-the-required-namespace">Create the required Namespace</a></li>
  <li><a href="#install-the-ibm-cert-manager" id="toc-install-the-ibm-cert-manager" class="nav-link" data-scroll-target="#install-the-ibm-cert-manager">Install the IBM Cert Manager</a></li>
  <li><a href="#configure-dns-resolution-optional" id="toc-configure-dns-resolution-optional" class="nav-link" data-scroll-target="#configure-dns-resolution-optional">Configure DNS resolution (Optional)</a></li>
  <li><a href="#install-foundational-services" id="toc-install-foundational-services" class="nav-link" data-scroll-target="#install-foundational-services">Install Foundational Services</a>
  <ul class="collapse">
  <li><a href="#verify-foundational-services-are-properly-installed" id="toc-verify-foundational-services-are-properly-installed" class="nav-link" data-scroll-target="#verify-foundational-services-are-properly-installed">Verify Foundational Services are properly installed</a></li>
  <li><a href="#verify-that-the-operand-requests-have-completed-and-installed" id="toc-verify-that-the-operand-requests-have-completed-and-installed" class="nav-link" data-scroll-target="#verify-that-the-operand-requests-have-completed-and-installed">Verify that the operand requests have completed and installed</a></li>
  <li><a href="#verify-ingress" id="toc-verify-ingress" class="nav-link" data-scroll-target="#verify-ingress">Verify Ingress</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Guardium Insights</li><li class="breadcrumb-item"><a href="../../../src/guardium_insights/eks/01_pre-reqs.html">EKS</a></li><li class="breadcrumb-item"><a href="../../../src/guardium_insights/eks/02_cluster-build.html">EKS Cluster Build</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">EKS Cluster build</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 18, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Links
</div>
</div>
<div class="callout-body-container callout-body">
<p>Some of these steps come from this documentation for <a href="https://www.ibm.com/docs/en/guardium-insights/3.x?topic=scenarios-installation-amazon-elastic-kubernetes-service-eks">Guardium Insights on EKS</a></p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>This assumes you have already configured <code>eksctl</code> and your aws configuration with your account info.</p>
<p>Our documented examples here are creating the cluster in the us-east region. This can be set to whatever region you want.</p>
</div>
</div>
<p>Run the <code>eksctl</code> command below to create your first cluster and perform the following:</p>
<ul>
<li>Create a 5-node Kubernetes cluster named <code>gi-east</code> with node type as <code>m6i.4xlarge</code> and region as <code>us-east-1</code>.</li>
<li>Control plane is managed by AWS EKS, so sizing for control plane nodes doesn’t apply.</li>
<li>Define a minimum of one node (<code>--nodes-min 5</code>) and a maximum of three-node (<code>--nodes-max 6</code>) for this node group managed by EKS.</li>
<li>Create a node group with the name <code>guardium-workers</code> and select a machine type for the <code>guardium-workers</code> node group.</li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Multiple AZ support]
</div>
</div>
<div class="callout-body-container callout-body">
<p>As of this writing, GI v3.5.0 does not officially support multiple availability zones. This is due to the fact that DB2 will not run across multiple availability zones. The rest of the product will run across zones but because DB2 will not, true availability will not be achieved with multiple availability zones.</p>
</div>
</div>
<section id="creating-the-cluster" class="level2">
<h2 class="anchored" data-anchor-id="creating-the-cluster">Creating the cluster</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
On cluster names
</div>
</div>
<div class="callout-body-container callout-body">
<p>We’re deploying in <code>us-east-1</code> and we are naming our cluster <code>gi-east</code>. This name will be exclusive to this cluster, so <code>gi-east</code> is an example here. You aren’t bound to using <code>gi-east</code> as your name.</p>
</div>
</div>
<p>Let’s set some env vars to make our lives easier.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="bu">export</span> <span class="va">clustername</span><span class="op">=</span>gi-east</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="bu">export</span> <span class="va">region</span><span class="op">=</span>us-east-1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">eksctl</span> create cluster <span class="dt">\</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>--name <span class="va">${clustername}</span> <span class="dt">\</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>--version 1.31 <span class="dt">\</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>--region <span class="va">${region}</span> <span class="dt">\</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>--zones <span class="va">${region}</span>a,<span class="va">${region}</span>b <span class="dt">\</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>--nodegroup-name guardium-workers <span class="dt">\</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>--node-type m6i.4xlarge <span class="dt">\</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>--with-oidc <span class="dt">\</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>--nodes 5 <span class="dt">\</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>--nodes-min 5 <span class="dt">\</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>--nodes-max 6 <span class="dt">\</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>--node-zones <span class="va">${region}</span>a <span class="dt">\</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>--tags <span class="st">"Product=Guardium"</span> <span class="dt">\</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>--managed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Associate an IAM oidc provider with the cluster if you didn’t include <code>--with-oidc</code> above.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">eksctl</span> utils associate-iam-oidc-provider <span class="at">--region</span><span class="op">=</span><span class="va">${region}</span> <span class="at">--cluster</span><span class="op">=</span><span class="va">${clustername}</span> <span class="at">--approve</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="configure-kubectl" class="level2">
<h2 class="anchored" data-anchor-id="configure-kubectl">Configure <code>kubectl</code></h2>
<p>Once the cluster is up, add it to your kube config. <code>eksctl</code> will probably do this for you.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">aws</span> eks update-kubeconfig <span class="at">--name</span> <span class="va">${clustername}</span> <span class="at">--region</span> <span class="va">${region}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Deploying Optional OPA Security Constraints
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you plan to use the Gatekeeper OPA on your cluster, follow the instructions <a href="../04_optional_services/#configure-security-constraints-optional">here</a></p>
</div>
</div>
</section>
<section id="install-the-ebs-driver-to-the-cluster" class="level2">
<h2 class="anchored" data-anchor-id="install-the-ebs-driver-to-the-cluster">Install the EBS driver to the cluster</h2>
<p>We install the EBS CSI driver as this gives us access to GP3 block storage.</p>
<p>Download the example ebs iam policy</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">curl</span> <span class="at">-o</span> iam-policy-example-ebs.json https://raw.githubusercontent.com/kubernetes-sigs/aws-ebs-csi-driver/master/docs/example-iam-policy.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create the policy. You can change <code>AmazonEKS_EBS_CSI_Driver_Policy</code> to a different name, but if you do, make sure to change it in later steps too.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">aws</span> iam create-policy <span class="dt">\</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>--policy-name AmazonEKS_EBS_CSI_Driver_Policy <span class="dt">\</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>--tags <span class="st">'{"Key": "Product","Value": "Guardium"}'</span> <span class="dt">\</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>--policy-document file://iam-policy-example-ebs.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output should be similar to below</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">{</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>    <span class="st">"Policy"</span><span class="ex">:</span> {</span>
<span id="cb7-3"><a href="#cb7-3"></a>        <span class="st">"PolicyName"</span><span class="ex">:</span> <span class="st">"AmazonEKS_EBS_CSI_Driver_Policy"</span>,</span>
<span id="cb7-4"><a href="#cb7-4"></a>        <span class="st">"PolicyId"</span><span class="ex">:</span> <span class="st">"ANPA24LVTCGN5YOUAVX2V"</span>,</span>
<span id="cb7-5"><a href="#cb7-5"></a>        <span class="st">"Arn"</span><span class="ex">:</span> <span class="st">"arn:aws:iam::&lt;ACCOUNT ID&gt;:policy/AmazonEKS_EBS_CSI_Driver_Policy"</span>,</span>
<span id="cb7-6"><a href="#cb7-6"></a>        <span class="st">"Path"</span><span class="ex">:</span> <span class="st">"/"</span>,</span>
<span id="cb7-7"><a href="#cb7-7"></a>        <span class="st">"DefaultVersionId"</span><span class="ex">:</span> <span class="st">"v1"</span>,</span>
<span id="cb7-8"><a href="#cb7-8"></a>        <span class="st">"AttachmentCount"</span><span class="ex">:</span> 0,</span>
<span id="cb7-9"><a href="#cb7-9"></a>        <span class="st">"PermissionsBoundaryUsageCount"</span><span class="ex">:</span> 0,</span>
<span id="cb7-10"><a href="#cb7-10"></a>        <span class="st">"IsAttachable"</span><span class="ex">:</span> true,</span>
<span id="cb7-11"><a href="#cb7-11"></a>        <span class="st">"CreateDate"</span><span class="ex">:</span> <span class="st">"2023-04-19T14:17:03+00:00"</span>,</span>
<span id="cb7-12"><a href="#cb7-12"></a>        <span class="st">"UpdateDate"</span><span class="ex">:</span> <span class="st">"2023-04-19T14:17:03+00:00"</span>,</span>
<span id="cb7-13"><a href="#cb7-13"></a>        <span class="st">"Tags"</span><span class="ex">:</span> [</span>
<span id="cb7-14"><a href="#cb7-14"></a>            <span class="kw">{</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>                <span class="st">"Key"</span><span class="ex">:</span> <span class="st">"Product"</span>,</span>
<span id="cb7-16"><a href="#cb7-16"></a>                <span class="st">"Value"</span><span class="ex">:</span> <span class="st">"Guardium"</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>            <span class="kw">}</span></span>
<span id="cb7-18"><a href="#cb7-18"></a>        <span class="ex">]</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>    <span class="kw">}</span></span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="er">}</span></span>
<span id="cb7-21"><a href="#cb7-21"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s export the returned arn as a env VAR for further use</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="bu">export</span> <span class="va">ebs_driver_policy_arn</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> iam list-policies <span class="at">--query</span> <span class="st">'Policies[?PolicyName==`AmazonEKS_EBS_CSI_Driver_Policy`].Arn'</span> <span class="at">--output</span> text<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now let’s export the rolename we are going to create as a env var. We’re going to append the cluster name to the role to differentiate in case we have multiple clusters in this account. You can share policies, but you cannot share roles.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="bu">export</span> <span class="va">ebs_driver_role_name</span><span class="op">=</span>AmazonEKS_EBS_CSI_DriverRole-<span class="va">${clustername}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create the service account</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">eksctl</span> create iamserviceaccount <span class="dt">\</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="at">--name</span> ebs-csi-controller-sa <span class="dt">\</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="at">--namespace</span> kube-system <span class="dt">\</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="at">--cluster</span> <span class="va">${clustername}</span> <span class="dt">\</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="at">--attach-policy-arn</span> <span class="va">$ebs_driver_policy_arn</span> <span class="dt">\</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="at">--approve</span> <span class="dt">\</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="at">--region</span><span class="op">=</span><span class="va">${region}</span> <span class="dt">\</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>  <span class="at">--tags</span> <span class="st">"Product=Guardium"</span> <span class="dt">\</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>  <span class="at">--role-only</span> <span class="dt">\</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>  <span class="at">--role-name</span> <span class="va">${ebs_driver_role_name}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s export the created role arn as another env var</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="bu">export</span> <span class="va">ebs_driver_role_arn</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> iam list-roles <span class="at">--query</span> <span class="st">'Roles[?RoleName==`AmazonEKS_EBS_CSI_DriverRole-'</span><span class="va">$clustername</span><span class="st">'`].Arn'</span> <span class="at">--output</span> text<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create the addon for the cluster</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">eksctl</span> create addon <span class="dt">\</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>--name aws-ebs-csi-driver <span class="dt">\</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>--cluster <span class="va">${clustername}</span> <span class="dt">\</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>--service-account-role-arn <span class="va">$ebs_driver_role_arn</span> <span class="dt">\</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>--region=<span class="va">${region}</span> <span class="dt">\</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>--force</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create the following StorageClass yaml to use gp3</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt;EOF</span> <span class="kw">|</span><span class="ex">kubectl</span> apply <span class="at">-f</span> <span class="at">-</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="st">apiVersion: storage.k8s.io/v1</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">kind: StorageClass</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">metadata:</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="st">  name: ebs-gp3-sc</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="st">provisioner: ebs.csi.aws.com</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="st">parameters:</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="st">  type: gp3</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="st">  fsType: ext4</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="st">reclaimPolicy: Delete</span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="st">volumeBindingMode: WaitForFirstConsumer</span></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="verifying-ebs" class="level3">
<h3 class="anchored" data-anchor-id="verifying-ebs">Verifying EBS</h3>
<p>Run the following command</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> <span class="at">-</span> <span class="op">&lt;&lt;EOF</span><span class="st"> </span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="st">apiVersion: v1 </span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="st">kind: PersistentVolumeClaim </span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="st">metadata: </span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="st">  name: block-pvc </span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="st">spec: </span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="st">  storageClassName: ebs-gp3-sc</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="st">  accessModes: </span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="st">    - ReadWriteOnce </span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="st">  resources: </span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="st">    requests: </span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="st">      storage: 1Gi </span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="st">--- </span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="st">apiVersion: v1 </span></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="st">kind: Pod </span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="st">metadata: </span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="st">  name: mypod </span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="st">spec: </span></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="st">  containers: </span></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="st">    - name: myfrontend </span></span>
<span id="cb14-21"><a href="#cb14-21"></a><span class="st">      image: nginx </span></span>
<span id="cb14-22"><a href="#cb14-22"></a><span class="st">      volumeMounts: </span></span>
<span id="cb14-23"><a href="#cb14-23"></a><span class="st">        - mountPath: "/var/www/html" </span></span>
<span id="cb14-24"><a href="#cb14-24"></a><span class="st">          name: mypd </span></span>
<span id="cb14-25"><a href="#cb14-25"></a><span class="st">  volumes: </span></span>
<span id="cb14-26"><a href="#cb14-26"></a><span class="st">    - name: mypd </span></span>
<span id="cb14-27"><a href="#cb14-27"></a><span class="st">      persistentVolumeClaim: </span></span>
<span id="cb14-28"><a href="#cb14-28"></a><span class="st">        claimName: block-pvc </span></span>
<span id="cb14-29"><a href="#cb14-29"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Verify the PVC was created</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="ex">kubectl</span> get pvc</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="ex">NAME</span>        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE</span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="ex">block-pvc</span>   Bound    pvc-67193212-3e10-46ab-a0a4-2834e3560c4a   1Gi        RWO            ebs-gp3-sc     <span class="op">&lt;</span>unset<span class="op">&gt;</span>                 7s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should see the bound status of the above pvc.</p>
<p>Delete the test pod and pvc</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a><span class="ex">kubectl</span> delete <span class="at">-f</span> <span class="at">-</span> <span class="op">&lt;&lt;EOF</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="st">apiVersion: v1</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="st">kind: PersistentVolumeClaim</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="st">metadata:</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="st">  name: block-pvc</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="st">spec:</span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="st">  storageClassName: ebs-gp3-sc</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="st">  accessModes:</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="st">    - ReadWriteOnce</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="st">  resources:</span></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="st">    requests:</span></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="st">      storage: 1Gi</span></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="st">---</span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="st">apiVersion: v1</span></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="st">kind: Pod</span></span>
<span id="cb16-16"><a href="#cb16-16"></a><span class="st">metadata:</span></span>
<span id="cb16-17"><a href="#cb16-17"></a><span class="st">  name: mypod</span></span>
<span id="cb16-18"><a href="#cb16-18"></a><span class="st">spec:</span></span>
<span id="cb16-19"><a href="#cb16-19"></a><span class="st">  containers:</span></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="st">    - name: myfrontend</span></span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="st">      image: nginx</span></span>
<span id="cb16-22"><a href="#cb16-22"></a><span class="st">      volumeMounts:</span></span>
<span id="cb16-23"><a href="#cb16-23"></a><span class="st">        - mountPath: "/var/www/html"</span></span>
<span id="cb16-24"><a href="#cb16-24"></a><span class="st">          name: mypd</span></span>
<span id="cb16-25"><a href="#cb16-25"></a><span class="st">  volumes:</span></span>
<span id="cb16-26"><a href="#cb16-26"></a><span class="st">    - name: mypd</span></span>
<span id="cb16-27"><a href="#cb16-27"></a><span class="st">      persistentVolumeClaim:</span></span>
<span id="cb16-28"><a href="#cb16-28"></a><span class="st">        claimName: block-pvc</span></span>
<span id="cb16-29"><a href="#cb16-29"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="enable-efs-on-the-cluster" class="level2">
<h2 class="anchored" data-anchor-id="enable-efs-on-the-cluster">Enable EFS on the cluster</h2>
<p>By default when we create a cluster with eksctl it defines and installs <code>gp2</code> storage class which is backed by Amazon’s EBS (elastic block storage). After that we installed the EBS CSI driver to support <code>gp3</code>. However, both <code>gp2</code> and <code>gp3</code> are both block storage. They will not support RWX in our cluster. We need to install an EFS storage class.</p>
<section id="create-iam-policy" class="level3">
<h3 class="anchored" data-anchor-id="create-iam-policy">Create IAM policy</h3>
<p>Download the IAM policy document from GitHub. You can also view the <a href="https://github.com/kubernetes-sigs/aws-efs-csi-driver/blob/master/docs/iam-policy-example.json">policy document</a></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a><span class="ex">curl</span> <span class="at">-o</span> iam-policy-example-efs.json https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/docs/iam-policy-example.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create the policy. You can change <code>AmazonEKS_EFS_CSI_Driver_Policy</code> to a different name, but if you do, make sure to change it in later steps too.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">aws</span> iam create-policy <span class="dt">\</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>--policy-name AmazonEKS_EFS_CSI_Driver_Policy <span class="dt">\</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>--tags <span class="st">'{"Key": "Product","Value": "Guardium"}'</span> <span class="dt">\</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>--policy-document file://iam-policy-example-efs.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output should be similar to below</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">{</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>    <span class="st">"Policy"</span><span class="ex">:</span> {</span>
<span id="cb19-3"><a href="#cb19-3"></a>        <span class="st">"PolicyName"</span><span class="ex">:</span> <span class="st">"AmazonEKS_EFS_CSI_Driver_Policy"</span>,</span>
<span id="cb19-4"><a href="#cb19-4"></a>        <span class="st">"PolicyId"</span><span class="ex">:</span> <span class="st">"ANPA3WENOYSA6LSFRSZ6U"</span>,</span>
<span id="cb19-5"><a href="#cb19-5"></a>        <span class="st">"Arn"</span><span class="ex">:</span> <span class="st">"arn:aws:iam::803455550593:policy/AmazonEKS_EFS_CSI_Driver_Policy"</span>,</span>
<span id="cb19-6"><a href="#cb19-6"></a>        <span class="st">"Path"</span><span class="ex">:</span> <span class="st">"/"</span>,</span>
<span id="cb19-7"><a href="#cb19-7"></a>        <span class="st">"DefaultVersionId"</span><span class="ex">:</span> <span class="st">"v1"</span>,</span>
<span id="cb19-8"><a href="#cb19-8"></a>        <span class="st">"AttachmentCount"</span><span class="ex">:</span> 0,</span>
<span id="cb19-9"><a href="#cb19-9"></a>        <span class="st">"PermissionsBoundaryUsageCount"</span><span class="ex">:</span> 0,</span>
<span id="cb19-10"><a href="#cb19-10"></a>        <span class="st">"IsAttachable"</span><span class="ex">:</span> true,</span>
<span id="cb19-11"><a href="#cb19-11"></a>        <span class="st">"CreateDate"</span><span class="ex">:</span> <span class="st">"2024-08-23T19:57:13+00:00"</span>,</span>
<span id="cb19-12"><a href="#cb19-12"></a>        <span class="st">"UpdateDate"</span><span class="ex">:</span> <span class="st">"2024-08-23T19:57:13+00:00"</span>,</span>
<span id="cb19-13"><a href="#cb19-13"></a>        <span class="st">"Tags"</span><span class="ex">:</span> [</span>
<span id="cb19-14"><a href="#cb19-14"></a>            <span class="kw">{</span></span>
<span id="cb19-15"><a href="#cb19-15"></a>                <span class="st">"Key"</span><span class="ex">:</span> <span class="st">"Product"</span>,</span>
<span id="cb19-16"><a href="#cb19-16"></a>                <span class="st">"Value"</span><span class="ex">:</span> <span class="st">"Guardium"</span></span>
<span id="cb19-17"><a href="#cb19-17"></a>            <span class="kw">}</span></span>
<span id="cb19-18"><a href="#cb19-18"></a>        <span class="ex">]</span></span>
<span id="cb19-19"><a href="#cb19-19"></a>    <span class="kw">}</span></span>
<span id="cb19-20"><a href="#cb19-20"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s export that policy arn as another env var</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a><span class="bu">export</span> <span class="va">efs_driver_policy_arn</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> iam list-policies <span class="at">--query</span> <span class="st">'Policies[?PolicyName==`AmazonEKS_EFS_CSI_Driver_Policy`].Arn'</span> <span class="at">--output</span> text<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-iam-role" class="level3">
<h3 class="anchored" data-anchor-id="create-iam-role">Create IAM role</h3>
<p>Now let’s export the rolename we are going to create as a env var. We’re going to append the cluster name to the role to differentiate in case we have multiple clusters in this account. You can share policies, but you cannot share roles.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1"></a><span class="bu">export</span> <span class="va">efs_driver_role_name</span><span class="op">=</span>AmazonEKS_EFS_CSI_DriverRole-<span class="va">${clustername}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create an IAM role and attach the IAM policy to it. Annotate the Kubernetes service account with the IAM role ARN and the IAM role with the Kubernetes service account name.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1"></a><span class="ex">eksctl</span> create iamserviceaccount <span class="dt">\</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>    <span class="at">--cluster</span> <span class="va">${clustername}</span> <span class="dt">\</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>    <span class="at">--namespace</span> kube-system <span class="dt">\</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>    <span class="at">--name</span> efs-csi-controller-sa <span class="dt">\</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>    <span class="at">--role-name</span> <span class="va">${efs_driver_role_name}</span> <span class="dt">\</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>    <span class="at">--attach-policy-arn</span> <span class="va">$efs_driver_policy_arn</span> <span class="dt">\</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>    <span class="at">--tags</span> <span class="st">"Product=Guardium"</span> <span class="dt">\</span></span>
<span id="cb22-8"><a href="#cb22-8"></a>    <span class="at">--approve</span> <span class="dt">\</span></span>
<span id="cb22-9"><a href="#cb22-9"></a>    <span class="at">--region</span> <span class="va">${region}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once created, check the iam service account is created running the following command.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a><span class="ex">eksctl</span> get iamserviceaccount <span class="at">--cluster</span> <span class="va">${clustername}</span> <span class="at">--region</span> <span class="va">${region}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Should return</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1"></a><span class="ex">NAMESPACE</span>   NAME            ROLE ARN</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="ex">kube-system</span> ebs-csi-controller-sa   arn:aws:iam::803455550593:role/AmazonEKS_EBS_CSI_DriverRole</span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="ex">kube-system</span> efs-csi-controller-sa   arn:aws:iam::803455550593:role/AmazonEKS_EFS_CSI_DriverRole</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="install-efs-csi-driver" class="level3">
<h3 class="anchored" data-anchor-id="install-efs-csi-driver">Install EFS CSI driver</h3>
<p>Now we just need our add-on registry address. This can be found here: https://docs.aws.amazon.com/eks/latest/userguide/add-ons-images.html</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The add-on registry address is per region. So based on the URL above, since our region is <code>us-east-1</code>, then our registry address would be <code>602401143452.dkr.ecr.us-east-1.amazonaws.com/eks/aws-efs-csi-driver</code></p>
</div>
</div>
<p>Let’s install the driver add-on to our clusters. We’re going to use <code>helm</code> for this.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1"></a><span class="ex">helm</span> repo add aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver/</span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="ex">helm</span> repo update</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Install a release of the driver using the Helm chart. Replace the repository address with the cluster’s <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-ons-images.html">container image address</a>.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1"></a><span class="ex">helm</span> upgrade <span class="at">-i</span> aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver <span class="dt">\</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>    <span class="at">--namespace</span> kube-system <span class="dt">\</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>    <span class="at">--set</span> image.repository=602401143452.dkr.ecr.us-east-1.amazonaws.com/eks/aws-efs-csi-driver <span class="dt">\</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>    <span class="at">--set</span> controller.serviceAccount.create=false <span class="dt">\</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>    <span class="at">--set</span> controller.serviceAccount.name=efs-csi-controller-sa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Verify that it installed correctly with this command</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1"></a><span class="ex">kubectl</span> get pod <span class="at">-n</span> kube-system <span class="at">-l</span> <span class="st">"app.kubernetes.io/name=aws-efs-csi-driver,app.kubernetes.io/instance=aws-efs-csi-driver"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Should return something like</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1"></a><span class="ex">NAME</span>                                  READY   STATUS    RESTARTS   AGE</span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="ex">efs-csi-controller-7fc77768fc-2swkw</span>   3/3     Running   0          2m13s</span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="ex">efs-csi-controller-7fc77768fc-c69rb</span>   3/3     Running   0          2m13s</span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="ex">efs-csi-node-ccxns</span>                    3/3     Running   0          2d17h</span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="ex">efs-csi-node-k52pt</span>                    3/3     Running   0          2d17h</span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="ex">efs-csi-node-r8nbm</span>                    3/3     Running   0          2d17h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-the-efs-filesystem" class="level3">
<h3 class="anchored" data-anchor-id="create-the-efs-filesystem">Create the EFS Filesystem</h3>
<p>Now we need to create the filesystem in EFS so we can use it</p>
<p>Export the following variables.</p>
<p>Get our VPC ID</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a><span class="va">vpc_id</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> eks describe-cluster <span class="dt">\</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>    <span class="at">--name</span> <span class="va">$clustername</span> <span class="dt">\</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>    <span class="at">--query</span> <span class="st">"cluster.resourcesVpcConfig.vpcId"</span> <span class="dt">\</span></span>
<span id="cb29-4"><a href="#cb29-4"></a>    <span class="at">--region</span> <span class="va">$region</span> <span class="dt">\</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>    <span class="at">--output</span> text<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Retrieve the CIDR range for your cluster’s VPC and store it in a variable for use in a later step.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1"></a><span class="va">cidr_range</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> ec2 describe-vpcs <span class="dt">\</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>    <span class="at">--vpc-ids</span> <span class="va">$vpc_id</span> <span class="dt">\</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>    <span class="at">--query</span> <span class="st">"Vpcs[].CidrBlock"</span> <span class="dt">\</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="at">--output</span> text <span class="dt">\</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>    <span class="at">--region</span> <span class="va">$region)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create a security group with an inbound rule that allows inbound NFS traffic for your Amazon EFS mount points.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1"></a><span class="va">security_group_id</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> ec2 create-security-group <span class="dt">\</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>    <span class="at">--group-name</span> EFS4FileNetSecurityGroup-<span class="va">${clustername}</span> <span class="dt">\</span></span>
<span id="cb31-3"><a href="#cb31-3"></a>    <span class="at">--description</span> <span class="st">"EFS security group for Guardium Insight cluster </span><span class="va">${clustername}</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb31-4"><a href="#cb31-4"></a>    <span class="at">--vpc-id</span> <span class="va">$vpc_id</span> <span class="dt">\</span></span>
<span id="cb31-5"><a href="#cb31-5"></a>    <span class="at">--region</span> <span class="va">$region</span> <span class="dt">\</span></span>
<span id="cb31-6"><a href="#cb31-6"></a>    <span class="at">--output</span> text<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create an inbound rule that allows inbound NFS traffic from the CIDR for your cluster’s VPC.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1"></a><span class="ex">aws</span> ec2 authorize-security-group-ingress <span class="dt">\</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>    <span class="at">--group-id</span> <span class="va">$security_group_id</span> <span class="dt">\</span></span>
<span id="cb32-3"><a href="#cb32-3"></a>    <span class="at">--protocol</span> tcp <span class="dt">\</span></span>
<span id="cb32-4"><a href="#cb32-4"></a>    <span class="at">--port</span> 2049 <span class="dt">\</span></span>
<span id="cb32-5"><a href="#cb32-5"></a>    <span class="at">--region</span> <span class="va">$region</span> <span class="dt">\</span></span>
<span id="cb32-6"><a href="#cb32-6"></a>    <span class="at">--cidr</span> <span class="va">$cidr_range</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create a file system.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1"></a><span class="va">file_system_id</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> efs create-file-system <span class="dt">\</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>    <span class="at">--region</span> <span class="va">$region</span> <span class="dt">\</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>    <span class="at">--encrypted</span> <span class="dt">\</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>    <span class="at">--tags</span> <span class="st">'{"Key": "Product","Value": "Guardium"}'</span> <span class="dt">\</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>    <span class="at">--performance-mode</span> generalPurpose <span class="dt">\</span></span>
<span id="cb33-6"><a href="#cb33-6"></a>    <span class="at">--query</span> <span class="st">'FileSystemId'</span> <span class="dt">\</span></span>
<span id="cb33-7"><a href="#cb33-7"></a>    <span class="at">--output</span> text<span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create mount targets.</p>
<p>Determine the IDs of the subnets in your VPC and which Availability Zone the subnet is in.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1"></a><span class="ex">aws</span> ec2 describe-subnets <span class="dt">\</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>    <span class="at">--filters</span> <span class="st">"Name=vpc-id,Values=</span><span class="va">$vpc_id</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>    <span class="at">--query</span> <span class="st">'Subnets[*].{SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock}'</span> <span class="dt">\</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>    <span class="at">--region</span> <span class="va">$region</span> <span class="dt">\</span></span>
<span id="cb34-5"><a href="#cb34-5"></a>    <span class="at">--output</span> table</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Should output something like the following</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1"></a><span class="ex">----------------------------------------------------------------------</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="kw">|</span>                           <span class="ex">DescribeSubnets</span>                          <span class="kw">|</span></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="ex">+------------------+--------------------+----------------------------+</span></span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="kw">|</span> <span class="ex">AvailabilityZone</span> <span class="kw">|</span>     <span class="ex">CidrBlock</span>      <span class="kw">|</span>         <span class="ex">SubnetId</span>           <span class="kw">|</span></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="ex">+------------------+--------------------+----------------------------+</span></span>
<span id="cb35-6"><a href="#cb35-6"></a><span class="kw">|</span>  <span class="ex">us-east-1c</span>      <span class="kw">|</span>  <span class="ex">192.168.64.0/19</span>   <span class="kw">|</span>  <span class="ex">subnet-08c33dce5e63c82dc</span>  <span class="kw">|</span></span>
<span id="cb35-7"><a href="#cb35-7"></a><span class="kw">|</span>  <span class="ex">us-east-1b</span>      <span class="kw">|</span>  <span class="ex">192.168.32.0/19</span>   <span class="kw">|</span>  <span class="ex">subnet-0f7a2b449320cc1e6</span>  <span class="kw">|</span></span>
<span id="cb35-8"><a href="#cb35-8"></a><span class="kw">|</span>  <span class="ex">us-east-1a</span>      <span class="kw">|</span>  <span class="ex">192.168.0.0/19</span>    <span class="kw">|</span>  <span class="ex">subnet-0ec499ae3eae19eb0</span>  <span class="kw">|</span></span>
<span id="cb35-9"><a href="#cb35-9"></a><span class="kw">|</span>  <span class="ex">us-east-1b</span>      <span class="kw">|</span>  <span class="ex">192.168.128.0/19</span>  <span class="kw">|</span>  <span class="ex">subnet-04f3d465138687333</span>  <span class="kw">|</span></span>
<span id="cb35-10"><a href="#cb35-10"></a><span class="kw">|</span>  <span class="ex">us-east-1a</span>      <span class="kw">|</span>  <span class="ex">192.168.96.0/19</span>   <span class="kw">|</span>  <span class="ex">subnet-0bc4d31344c60c113</span>  <span class="kw">|</span></span>
<span id="cb35-11"><a href="#cb35-11"></a><span class="kw">|</span>  <span class="ex">us-east-1c</span>      <span class="kw">|</span>  <span class="ex">192.168.160.0/19</span>  <span class="kw">|</span>  <span class="ex">subnet-0bee6fc06187cafd1</span>  <span class="kw">|</span></span>
<span id="cb35-12"><a href="#cb35-12"></a><span class="ex">+------------------+--------------------+----------------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Add mount targets for the subnets that your nodes are in.</p>
<p>Run the following command:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1"></a><span class="cf">for</span> subnet <span class="kw">in</span> <span class="va">$(</span><span class="ex">aws</span> ec2 describe-subnets <span class="at">--filters</span> <span class="st">"Name=vpc-id,Values=</span><span class="va">$vpc_id</span><span class="st">"</span> <span class="at">--query</span> <span class="st">'Subnets[*].{SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock}'</span> <span class="at">--region</span> <span class="va">$region</span> <span class="at">--output</span> text <span class="kw">|</span> <span class="fu">awk</span> <span class="st">'{print $3}'</span><span class="va">)</span> <span class="kw">;</span> <span class="cf">do</span> <span class="ex">aws</span> efs create-mount-target <span class="at">--file-system-id</span> <span class="va">$file_system_id</span> <span class="at">--region</span> <span class="va">$region</span> <span class="at">--subnet-id</span> <span class="va">$subnet</span> <span class="at">--security-groups</span> <span class="va">$security_group_id</span> <span class="kw">;</span> <span class="cf">done</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This wraps the below command in a for loop that will iterate through your subnet ids.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1"></a><span class="ex">aws</span> efs create-mount-target <span class="dt">\</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>    <span class="at">--file-system-id</span> <span class="va">$file_system_id</span> <span class="dt">\</span></span>
<span id="cb37-3"><a href="#cb37-3"></a>    <span class="at">--region</span> <span class="va">$region</span> <span class="dt">\</span></span>
<span id="cb37-4"><a href="#cb37-4"></a>    <span class="at">--subnet-id</span> <span class="op">&lt;</span>SUBNETID<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb37-5"><a href="#cb37-5"></a>    <span class="at">--security-groups</span> <span class="va">$security_group_id</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-efs-storage-class" class="level3">
<h3 class="anchored" data-anchor-id="create-efs-storage-class">Create EFS Storage Class</h3>
<p>Create a storage class for dynamic provisioning</p>
<p>Let’s get our filesystem ID if we don’t already have it above. However if you ran the above steps, <code>$file_system_id</code> should already be defined.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1"></a><span class="ex">aws</span> efs describe-file-systems <span class="dt">\</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>--query <span class="st">"FileSystems[*].FileSystemId"</span> <span class="dt">\</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>--region <span class="va">$region</span> <span class="dt">\</span></span>
<span id="cb38-4"><a href="#cb38-4"></a>--output text</span>
<span id="cb38-5"><a href="#cb38-5"></a></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="ex">fs-071439ffb7e10b67b</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you did not export the <code>$file_system_id</code> variable, make sure the filesystem id you use in the below command is the filesystem id that was returned to you above!</p>
</div>
</div>
<p>Create the storage class</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt;EOF</span> <span class="kw">|</span> <span class="ex">envsubst</span> <span class="kw">|</span> <span class="ex">kubectl</span> apply <span class="at">-f</span> <span class="at">-</span></span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="st">apiVersion: storage.k8s.io/v1</span></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="st">kind: StorageClass</span></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="st">metadata:</span></span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="st">  name: efs-sc</span></span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="st">parameters:</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="st">  uid: "0"</span></span>
<span id="cb39-8"><a href="#cb39-8"></a><span class="st">  gid: "0"</span></span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="st">  directoryPerms: "777"</span></span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="st">  fileSystemId: </span><span class="va">${file_system_id}</span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="st">  provisioningMode: efs-ap</span></span>
<span id="cb39-12"><a href="#cb39-12"></a><span class="st">provisioner: efs.csi.aws.com</span></span>
<span id="cb39-13"><a href="#cb39-13"></a><span class="st">reclaimPolicy: Delete</span></span>
<span id="cb39-14"><a href="#cb39-14"></a><span class="st">volumeBindingMode: Immediate</span></span>
<span id="cb39-15"><a href="#cb39-15"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Setting Default Storage Class
</div>
</div>
<div class="callout-body-container callout-body">
<p>Set one of the EFS storage classes as the default storage class only if you intend on primarily using EFS. Otherwise set block storage as default.</p>
<p>If using EFS as primary storage</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1"></a><span class="ex">kubectl</span> patch storageclass efs-sc <span class="at">-p</span> <span class="st">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If using EBS(block) as primary storage</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1"></a><span class="ex">kubectl</span> patch storageclass ebs-gp3-sc <span class="at">-p</span> <span class="st">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Finally, verify they are both there</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1"></a><span class="ex">kubectl</span> get sc</span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="ex">NAME</span>               PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="ex">ebs-gp3-sc</span>         ebs.csi.aws.com         Delete          WaitForFirstConsumer   false                  6d18h</span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="ex">efs-sc</span> <span class="er">(</span><span class="ex">default</span><span class="kw">)</span>   <span class="ex">efs.csi.aws.com</span>         Delete          Immediate              false                  16h</span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="ex">gp2</span>                kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  6d23h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="verify-efs" class="level3">
<h3 class="anchored" data-anchor-id="verify-efs">Verify EFS</h3>
<p>Run the following command to create a pod and a PVC using the default EFS storage class</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> <span class="at">-</span> <span class="op">&lt;&lt;EOF</span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="st">apiVersion: v1</span></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="st">kind: PersistentVolumeClaim</span></span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="st">metadata:</span></span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="st">  name: block-pvc</span></span>
<span id="cb43-6"><a href="#cb43-6"></a><span class="st">spec:</span></span>
<span id="cb43-7"><a href="#cb43-7"></a><span class="st">  storageClassName: efs-sc</span></span>
<span id="cb43-8"><a href="#cb43-8"></a><span class="st">  accessModes:</span></span>
<span id="cb43-9"><a href="#cb43-9"></a><span class="st">    - ReadWriteOnce</span></span>
<span id="cb43-10"><a href="#cb43-10"></a><span class="st">  resources:</span></span>
<span id="cb43-11"><a href="#cb43-11"></a><span class="st">    requests:</span></span>
<span id="cb43-12"><a href="#cb43-12"></a><span class="st">      storage: 1Gi</span></span>
<span id="cb43-13"><a href="#cb43-13"></a><span class="st">---</span></span>
<span id="cb43-14"><a href="#cb43-14"></a><span class="st">apiVersion: v1</span></span>
<span id="cb43-15"><a href="#cb43-15"></a><span class="st">kind: Pod</span></span>
<span id="cb43-16"><a href="#cb43-16"></a><span class="st">metadata:</span></span>
<span id="cb43-17"><a href="#cb43-17"></a><span class="st">  name: mypod</span></span>
<span id="cb43-18"><a href="#cb43-18"></a><span class="st">spec:</span></span>
<span id="cb43-19"><a href="#cb43-19"></a><span class="st">  containers:</span></span>
<span id="cb43-20"><a href="#cb43-20"></a><span class="st">    - name: myfrontend</span></span>
<span id="cb43-21"><a href="#cb43-21"></a><span class="st">      image: nginx</span></span>
<span id="cb43-22"><a href="#cb43-22"></a><span class="st">      volumeMounts:</span></span>
<span id="cb43-23"><a href="#cb43-23"></a><span class="st">        - mountPath: "/var/www/html"</span></span>
<span id="cb43-24"><a href="#cb43-24"></a><span class="st">          name: mypd</span></span>
<span id="cb43-25"><a href="#cb43-25"></a><span class="st">  volumes:</span></span>
<span id="cb43-26"><a href="#cb43-26"></a><span class="st">    - name: mypd</span></span>
<span id="cb43-27"><a href="#cb43-27"></a><span class="st">      persistentVolumeClaim:</span></span>
<span id="cb43-28"><a href="#cb43-28"></a><span class="st">        claimName: block-pvc</span></span>
<span id="cb43-29"><a href="#cb43-29"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Running the following command should verify the PVC was successfully created and bound</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1"></a><span class="ex">kubectl</span> get pvc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1"></a><span class="ex">NAME</span>        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE</span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="ex">block-pvc</span>   Bound    pvc-dc711246-02a1-4a9d-b428-a2476b17dd8c   1Gi        RWO            efs-sc         <span class="op">&lt;</span>unset<span class="op">&gt;</span>                 4s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we can delete our test pod and pvc</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1"></a><span class="ex">kubectl</span> delete <span class="at">-f</span> <span class="at">-</span> <span class="op">&lt;&lt;EOF</span></span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="st">apiVersion: v1</span></span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="st">kind: PersistentVolumeClaim</span></span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="st">metadata:</span></span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="st">  name: block-pvc</span></span>
<span id="cb46-6"><a href="#cb46-6"></a><span class="st">spec:</span></span>
<span id="cb46-7"><a href="#cb46-7"></a><span class="st">  storageClassName: efs-sc</span></span>
<span id="cb46-8"><a href="#cb46-8"></a><span class="st">  accessModes:</span></span>
<span id="cb46-9"><a href="#cb46-9"></a><span class="st">    - ReadWriteOnce</span></span>
<span id="cb46-10"><a href="#cb46-10"></a><span class="st">  resources:</span></span>
<span id="cb46-11"><a href="#cb46-11"></a><span class="st">    requests:</span></span>
<span id="cb46-12"><a href="#cb46-12"></a><span class="st">      storage: 1Gi</span></span>
<span id="cb46-13"><a href="#cb46-13"></a><span class="st">---</span></span>
<span id="cb46-14"><a href="#cb46-14"></a><span class="st">apiVersion: v1</span></span>
<span id="cb46-15"><a href="#cb46-15"></a><span class="st">kind: Pod</span></span>
<span id="cb46-16"><a href="#cb46-16"></a><span class="st">metadata:</span></span>
<span id="cb46-17"><a href="#cb46-17"></a><span class="st">  name: mypod</span></span>
<span id="cb46-18"><a href="#cb46-18"></a><span class="st">spec:</span></span>
<span id="cb46-19"><a href="#cb46-19"></a><span class="st">  containers:</span></span>
<span id="cb46-20"><a href="#cb46-20"></a><span class="st">    - name: myfrontend</span></span>
<span id="cb46-21"><a href="#cb46-21"></a><span class="st">      image: nginx</span></span>
<span id="cb46-22"><a href="#cb46-22"></a><span class="st">      volumeMounts:</span></span>
<span id="cb46-23"><a href="#cb46-23"></a><span class="st">        - mountPath: "/var/www/html"</span></span>
<span id="cb46-24"><a href="#cb46-24"></a><span class="st">          name: mypd</span></span>
<span id="cb46-25"><a href="#cb46-25"></a><span class="st">  volumes:</span></span>
<span id="cb46-26"><a href="#cb46-26"></a><span class="st">    - name: mypd</span></span>
<span id="cb46-27"><a href="#cb46-27"></a><span class="st">      persistentVolumeClaim:</span></span>
<span id="cb46-28"><a href="#cb46-28"></a><span class="st">        claimName: block-pvc</span></span>
<span id="cb46-29"><a href="#cb46-29"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="install-nginx-controller" class="level2">
<h2 class="anchored" data-anchor-id="install-nginx-controller">Install NGINX Controller</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
On Ingresses
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you plan on using AWS ALB for ingress, follow the directions <a href="../../../guardium_insights/04_optional_services/#optional-install-the-alb-ingress-controller">here</a></p>
</div>
</div>
<p>Let’s install the NGINX helm chart</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1"></a><span class="ex">helm</span> repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="ex">helm</span> repo update</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create the namespace for NGINX</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1"></a><span class="ex">kubectl</span> create ns ingress-nginx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Public vs Private ingress
</div>
</div>
<div class="callout-body-container callout-body">
<p>Below is for a public facing ingress. Yours might need to be internal only so you would set the <code>aws-load-balancer-scheme</code> to <code>internal</code> if it needs to be internal.</p>
</div>
</div>
<div class="sourceCode" id="cb49"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1"></a><span class="ex">helm</span> install ingress-nginx ingress-nginx/ingress-nginx <span class="dt">\</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>--set-string controller.service.annotations.<span class="st">'service\.beta\.kubernetes\.io/aws-load-balancer-backend-protocol'</span>=tcp <span class="dt">\</span></span>
<span id="cb49-3"><a href="#cb49-3"></a>--set-string controller.service.annotations.<span class="st">'service\.beta\.kubernetes\.io/aws-load-balancer-cross-zone-load-balancing-enabled'</span>=<span class="st">"true"</span> <span class="dt">\</span></span>
<span id="cb49-4"><a href="#cb49-4"></a>--set-string controller.service.annotations.<span class="st">'service\.beta\.kubernetes\.io/aws-load-balancer-scheme'</span>=internet-facing <span class="dt">\</span></span>
<span id="cb49-5"><a href="#cb49-5"></a>--set-string controller.service.annotations.<span class="st">"service\.beta\.kubernetes\.io/aws-load-balancer-nlb-target-type"</span>=ip <span class="dt">\</span></span>
<span id="cb49-6"><a href="#cb49-6"></a>--set-string controller.service.annotations.<span class="st">'service\.beta\.kubernetes\.io/aws-load-balancer-type'</span>=nlb <span class="dt">\</span></span>
<span id="cb49-7"><a href="#cb49-7"></a>--namespace=ingress-nginx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Run the following command to verify that a load balancer was assigned</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1"></a><span class="ex">kubectl</span> get service <span class="at">--namespace</span> ingress-nginx ingress-nginx-controller</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb51"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1"></a><span class="ex">NAME</span>                       TYPE           CLUSTER-IP       EXTERNAL-IP                                                                     PORT<span class="er">(</span><span class="ex">S</span><span class="kw">)</span>                      <span class="ex">AGE</span></span>
<span id="cb51-2"><a href="#cb51-2"></a><span class="ex">ingress-nginx-controller</span>   LoadBalancer   10.100.204.215   a904f47d90a8c4961ae389b155359368-aa0f265b8588c710.elb.us-east-1.amazonaws.com   80:30870/TCP,443:31883/TCP   61s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="verify-the-nginx-deployment" class="level3">
<h3 class="anchored" data-anchor-id="verify-the-nginx-deployment">Verify the NGINX deployment</h3>
<p>Verify the deployment</p>
<p>Command:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1"></a><span class="ex">kubectl</span> get ingressclass</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Example output:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1"></a><span class="ex">NAME</span>    CONTROLLER             PARAMETERS   AGE</span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="ex">nginx</span>   k8s.io/ingress-nginx   <span class="op">&lt;</span>none<span class="op">&gt;</span>       2m43s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="install-the-operator-lifecycle-manager" class="level2">
<h2 class="anchored" data-anchor-id="install-the-operator-lifecycle-manager">Install the Operator Lifecycle Manager</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Permissions for OLM
</div>
</div>
<div class="callout-body-container callout-body">
<p>The default method of installing OLM is to use the <code>operator-sdk</code> command line tool. This method creates <code>ClusterRole</code> and <code>ClusterRoleBinding</code> resources that require wildcard permissions at the cluster level.</p>
<p>If the security on your cluster is configured to not allow wildcard permissions at the cluster level, proceed with the “Custom OLM” section below to install OLM without wildcard permissions.</p>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">operator-sdk</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Custom OLM</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>Run the following command using the <code>operator-sdk</code></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1"></a><span class="ex">operator-sdk</span> olm install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Download (Save link as…) the customized <a href="https://ibm-client-engineering.github.io/engineering-journal-quantum-safe/olm/crds.yaml">crds.yaml</a> and <a href="https://ibm-client-engineering.github.io/engineering-journal-quantum-safe/olm/olm.yaml">olm.yaml</a> for OLM v0.28.0. Keep in mind, this is a point in time customization for GI 3.5.0 and OLM v0.28.0.</p>
<p>Create the CRDs</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1"></a><span class="ex">kubectl</span> create <span class="at">-f</span> crds.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ensure that CRDs were applied.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1"></a><span class="ex">kubectl</span> wait <span class="at">--for</span><span class="op">=</span>condition=Established <span class="at">-f</span> crds.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create the OLM resources</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1"></a><span class="ex">kubectl</span> create <span class="at">-f</span> olm.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Wait for deployments to be ready.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1"></a><span class="ex">kubectl</span> rollout status <span class="at">-w</span> deployment/olm-operator <span class="at">--namespace</span><span class="op">=</span><span class="st">"olm"</span></span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="ex">kubectl</span> rollout status <span class="at">-w</span> deployment/catalog-operator <span class="at">--namespace</span><span class="op">=</span><span class="st">"olm"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>Verify the installation</p>
<pre><code>kubectl get csv -n olm | grep packageserver</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1"></a><span class="ex">packageserver</span>   Package Server   0.28.0               Succeeded</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Set the OLM global namespade to use openshift-marketplace</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb61-1"><a href="#cb61-1"></a><span class="ex">oc</span> set env deploy/catalog-operator GLOBAL_CATALOG_NAMESPACE=openshift-marketplace <span class="at">-n</span> olm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We further require to change the global namespace for the packageserver as well. To do so, run the following command:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb62-1"><a href="#cb62-1"></a><span class="ex">kubectl</span> patch csv packageserver <span class="at">-n</span> olm <span class="at">--type</span><span class="op">=</span><span class="st">'json'</span> <span class="at">-p</span><span class="op">=</span><span class="st">'[</span></span>
<span id="cb62-2"><a href="#cb62-2"></a><span class="st">  {</span></span>
<span id="cb62-3"><a href="#cb62-3"></a><span class="st">    "op": "replace",</span></span>
<span id="cb62-4"><a href="#cb62-4"></a><span class="st">    "path": "/spec/install/spec/deployments/0/spec/template/spec/containers/0/command/5",</span></span>
<span id="cb62-5"><a href="#cb62-5"></a><span class="st">    "value": "openshift-marketplace"</span></span>
<span id="cb62-6"><a href="#cb62-6"></a><span class="st">  }</span></span>
<span id="cb62-7"><a href="#cb62-7"></a><span class="st">]'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Verify the global-namespace has been set</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1"></a><span class="ex">kubectl</span> get deploy packageserver <span class="at">-n</span> olm <span class="at">-o</span> yaml <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-A</span> 6 <span class="st">"command:"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Should return</p>
<div class="sourceCode" id="annotated-cell-57"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-57-1"><a href="#annotated-cell-57-1"></a>      <span class="sc">-</span> command<span class="sc">:</span></span>
<span id="annotated-cell-57-2"><a href="#annotated-cell-57-2"></a>        <span class="sc">-</span> <span class="er">/</span>bin<span class="sc">/</span>package<span class="sc">-</span>server</span>
<span id="annotated-cell-57-3"><a href="#annotated-cell-57-3"></a>        <span class="sc">-</span> <span class="sc">-</span>v<span class="ot">=</span><span class="dv">4</span></span>
<span id="annotated-cell-57-4"><a href="#annotated-cell-57-4"></a>        <span class="sc">-</span> <span class="sc">--</span>secure<span class="sc">-</span>port</span>
<span id="annotated-cell-57-5"><a href="#annotated-cell-57-5"></a>        <span class="sc">-</span> <span class="st">"5443"</span></span>
<span id="annotated-cell-57-6"><a href="#annotated-cell-57-6"></a>        <span class="sc">-</span> <span class="sc">--</span>global<span class="sc">-</span>namespace</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-57-7" class="code-annotation-target"><a href="#annotated-cell-57-7"></a>        <span class="sc">-</span> openshift<span class="sc">-</span>marketplace</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-57" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="7" data-code-annotation="1">This is the value we care about</span>
</dd>
</dl>
</section>
<section id="create-the-required-namespace" class="level2">
<h2 class="anchored" data-anchor-id="create-the-required-namespace">Create the required Namespace</h2>
<div class="sourceCode" id="cb64"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1"></a><span class="ex">kubectl</span> create ns openshift-marketplace</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Set our context to that namespace and export it as an env var</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb65-1"><a href="#cb65-1"></a><span class="bu">export</span> <span class="va">NAMESPACE</span><span class="op">=</span>openshift-marketplace</span>
<span id="cb65-2"><a href="#cb65-2"></a></span>
<span id="cb65-3"><a href="#cb65-3"></a><span class="ex">kubectl</span> config set-context <span class="at">--current</span> <span class="at">--namespace</span> <span class="va">$NAMESPACE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="install-the-ibm-cert-manager" class="level2">
<h2 class="anchored" data-anchor-id="install-the-ibm-cert-manager">Install the IBM Cert Manager</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
On Cert Managers
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you cannot use the IBM Cert Manager, follow the directions <a href="../../../guardium_insights/04_optional_services/#installing-community-cert-manager">here</a></p>
</div>
</div>
<p>If you followed the directions <a href="../01_pre-reqs/#downloading-the-case-file">here</a> you should have the <code>ibm-guardium-insights</code> case file downloaded and extracted.</p>
<p>Change to the following directory</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb66-1"><a href="#cb66-1"></a><span class="bu">cd</span> ibm-guardium-data-security-center/inventory/install/files/support/eks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Create the namespace and then run the installation script</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1"></a><span class="ex">kubectl</span> create namespace ibm-cert-manager</span>
<span id="cb67-2"><a href="#cb67-2"></a><span class="fu">chmod</span> +x ibm-cert-manager.sh</span>
<span id="cb67-3"><a href="#cb67-3"></a><span class="ex">./ibm-cert-manager.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Give it a few minutes and then verify the cert manager is up</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb68-1"><a href="#cb68-1"></a><span class="ex">kubectl</span> get po <span class="at">-n</span> ibm-cert-manager</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>NAME                                                              READY   STATUS      RESTARTS   AGE
cd6e1c2b84458a4f431f49f499a919d28af0b23693e36f2fc53bc1f2c3hw5pw   0/1     Completed   0          2m1s
cert-manager-cainjector-85777f77cc-hbzg7                          1/1     Running     0          102s
cert-manager-controller-957bc947-kg5wx                            1/1     Running     0          102s
cert-manager-webhook-5586d798f-lcsln                              1/1     Running     0          102s
ibm-cert-manager-catalog-rcbvc                                    1/1     Running     0          2m12s
ibm-cert-manager-operator-64fc5b4644-rnpqg                        1/1     Running     0          108s</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1"></a><span class="ex">kubectl</span> get csv <span class="at">-n</span> ibm-cert-manager</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>NAME                               DISPLAY            VERSION   REPLACES   PHASE
ibm-cert-manager-operator.v4.2.7   IBM Cert Manager   4.2.7                Succeeded</code></pre>
</section>
<section id="configure-dns-resolution-optional" class="level2">
<h2 class="anchored" data-anchor-id="configure-dns-resolution-optional">Configure DNS resolution (Optional)</h2>
<p>If you are following the instrutions in this guide using the “insecure” hostname sections to avoid registering domains, it’s possible to use Route 53 in AWS set up explicit DNS resolution for the specific host routes needed.</p>
<p>Go to <a href="https://console.aws.amazon.com/route53/">AWS Route 53</a> and click <code>Hosted zones</code> heading. Then click the <code>Create hosted zone</code> button. This will open the hosted zone form.</p>
<p>For the domain use</p>
<pre><code>apps.gi.guardium-insights.com</code></pre>
<p>For type, select <code>Private hosted zone</code></p>
<p>For the VPCs to associate with the hosted zone, select the proper region, then select the VPC that was created for your cluster.</p>
<p><a href="../../../images/public_hosted_zone_01.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="../../../images/public_hosted_zone_01.png" class="img-fluid"></a></p>
<p>Then click <code>Create Hosted zone</code> button to create the hosted zone.</p>
<p>This will take you to the hosted zone details page. Now it’s time to create some records for DNS resolution. But first we need the values to use for the internal routing.</p>
<p>Find the external cluster IP address of the load balancer under <code>EXTERNAL-IP</code>.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb73-1"><a href="#cb73-1"></a><span class="ex">kubectl</span> get service <span class="at">--namespace</span> ingress-nginx ingress-nginx-controller</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb74"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1"></a><span class="ex">NAME</span>                       TYPE           CLUSTER-IP      EXTERNAL-IP                                                                     PORT<span class="er">(</span><span class="ex">S</span><span class="kw">)</span>                      <span class="ex">AGE</span></span>
<span id="cb74-2"><a href="#cb74-2"></a><span class="ex">ingress-nginx-controller</span>   LoadBalancer   10.100.24.243   a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com   80:31369/TCP,443:30370/TCP   20h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Capture that <code>EXTERNAL-IP</code> value for the next steps.</p>
<p>Back on the hosted zone details page, click the <code>Create record</code> button.</p>
<p>We want to create a <code>CNAME</code> record that routes <code>*.apps.gi.guardium-insights.com</code> to the external cluster IP address captured above.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://private-user-images.githubusercontent.com/137658020/396157933-da3edef3-9a47-47fd-bb9c-c386406ec48c.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzQzNzg0MTksIm5iZiI6MTczNDM3ODExOSwicGF0aCI6Ii8xMzc2NTgwMjAvMzk2MTU3OTMzLWRhM2VkZWYzLTlhNDctNDdmZC1iYjljLWMzODY0MDZlYzQ4Yy5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjQxMjE2JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI0MTIxNlQxOTQxNTlaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1mMTc3ZjhjNGNhZWU0Y2MwZmRhZDRhMDhhMTQzYzJmMzJlNDVhMTRhYjI3YTU1NTA2ZTk5YzliODZhYzI0ZGIwJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.M1n79fF4eXHtd6j05ZGneCYN1SQkUJS-WS8TiDY61Us" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="image"><img src="https://private-user-images.githubusercontent.com/137658020/396157933-da3edef3-9a47-47fd-bb9c-c386406ec48c.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzQzNzg0MTksIm5iZiI6MTczNDM3ODExOSwicGF0aCI6Ii8xMzc2NTgwMjAvMzk2MTU3OTMzLWRhM2VkZWYzLTlhNDctNDdmZC1iYjljLWMzODY0MDZlYzQ4Yy5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjQxMjE2JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI0MTIxNlQxOTQxNTlaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1mMTc3ZjhjNGNhZWU0Y2MwZmRhZDRhMDhhMTQzYzJmMzJlNDVhMTRhYjI3YTU1NTA2ZTk5YzliODZhYzI0ZGIwJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.M1n79fF4eXHtd6j05ZGneCYN1SQkUJS-WS8TiDY61Us" class="img-fluid figure-img" alt="image"></a></p>
<figcaption>image</figcaption>
</figure>
</div>
<p>Click <code>Create Records</code>.</p>
</section>
<section id="install-foundational-services" class="level2">
<h2 class="anchored" data-anchor-id="install-foundational-services">Install Foundational Services</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Entitlement
</div>
</div>
<div class="callout-body-container callout-body">
<p>As noted <a href="../guardium_insights/01_pre-reqs/">here</a> make sure you have retrieved your entitlement key for the next step</p>
</div>
</div>
<p>Export your entitlement key as an env var</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1"></a><span class="bu">export</span> <span class="va">IBMKEY</span><span class="op">=</span><span class="st">"&lt;entitlement key&gt;"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Change to the following directory</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1"></a><span class="bu">cd</span> ibm-guardium-data-security-center/inventory/install/files/support/eks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As of this writing, we are using Guardium Data Security center v3.6.0 which uses bundle version 2.6.0.</p>
<p>Export the following vars</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb77-1"><a href="#cb77-1"></a><span class="bu">export</span> <span class="va">REPLACE_NAMESPACE</span><span class="op">=</span>openshift-marketplace</span>
<span id="cb77-2"><a href="#cb77-2"></a><span class="bu">export</span> <span class="va">NAMESPACE</span><span class="op">=</span>openshift-marketplace</span>
<span id="cb77-3"><a href="#cb77-3"></a><span class="bu">export</span> <span class="va">ICS_INVENTORY_SETUP</span><span class="op">=</span>ibmCommonServiceOperatorSetup</span>
<span id="cb77-4"><a href="#cb77-4"></a><span class="bu">export</span> <span class="va">ICS_SIZE</span><span class="op">=</span>starterset</span>
<span id="cb77-5"><a href="#cb77-5"></a><span class="bu">export</span> <span class="va">IBMPAK_LAUNCH_SKIP_PREREQ_CHECK</span><span class="op">=</span>true</span>
<span id="cb77-6"><a href="#cb77-6"></a><span class="bu">export</span> <span class="va">CP_REPO_USER</span><span class="op">=</span><span class="st">"cp"</span></span>
<span id="cb77-7"><a href="#cb77-7"></a><span class="bu">export</span> <span class="va">CP_REPO_PASS</span><span class="op">=</span><span class="va">${IBMKEY}</span></span>
<span id="cb77-8"><a href="#cb77-8"></a><span class="bu">export</span> <span class="va">NAMESPACE</span><span class="op">=</span><span class="st">"openshift-marketplace"</span></span>
<span id="cb77-9"><a href="#cb77-9"></a><span class="bu">export</span> <span class="va">CASE_NAME</span><span class="op">=</span>ibm-guardium-data-security-center</span>
<span id="cb77-10"><a href="#cb77-10"></a><span class="bu">export</span> <span class="va">CASE_VERSION</span><span class="op">=</span>2.6.0</span>
<span id="cb77-11"><a href="#cb77-11"></a><span class="bu">export</span> <span class="va">LOCAL_CASE_DIR</span><span class="op">=</span><span class="va">$HOME</span>/.ibm-pak/data/cases/<span class="va">$CASE_NAME</span>/<span class="va">$CASE_VERSION</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Save the CASE bundle locally</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb78-1"><a href="#cb78-1"></a><span class="ex">oc</span> ibm-pak get <span class="va">$CASE_NAME</span> <span class="dt">\</span></span>
<span id="cb78-2"><a href="#cb78-2"></a>--version <span class="va">$CASE_VERSION</span> <span class="dt">\</span></span>
<span id="cb78-3"><a href="#cb78-3"></a>--skip-verify</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will download the CASE bundle to <code>$HOME/.ibm-pak/data/cases/ibm-guardium-data-security-center/2.6.0</code></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
On DNS
</div>
</div>
<div class="callout-body-container callout-body">
<p>Whether you’re using Route 53 or external DNS, a CNAME must be created if you’re using NGINX as your Ingress Controller.</p>
<p>For our example setup, we are working with the <code>thinkforward.work</code> domain. So we set the domain in our remote dns to <code>apps.gi.thinkforward.work</code>. Other users may need to configure their FQDN in AWS Route 53.</p>
<p>The important part is there must be a wildcard subdomain. It should point to our loadbalancer.</p>
<p>Retrieve the loadbalancer ip with this command:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb79-1"><a href="#cb79-1"></a><span class="ex">kubectl</span> get service <span class="at">--namespace</span> ingress-nginx ingress-nginx-controller</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Should return <code>bash {2} NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP                                                                     PORT(S)                      AGE ingress-nginx-controller   LoadBalancer   10.100.129.192   k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com   80:32113/TCP,443:31457/TCP   24h</code></p>
<p>Our external IP above is <code>k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com</code></p>
<p>So for us, our actual DNS record should be like this:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb80-1"><a href="#cb80-1"></a><span class="ex">CNAME</span>    <span class="pp">*</span>.gi-east.apps.thinkforward.work  <span class="at">-</span><span class="op">&gt;</span>  k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>*</code> wildcard ensures that any subdomain generated by GI will map back to that loadbalancer.</p>
</div>
</div>
<p>Export the hostname as an env var. It’s important to note that your domain must begin with <code>apps</code>. If you have multiple clusters, a good practices would be <code>apps.&lt;CLUSTERNAME&gt;.&lt;DOMAIN&gt;</code>.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb81-1"><a href="#cb81-1"></a><span class="bu">export</span> <span class="va">HOSTNAME</span><span class="op">=</span>apps.gi.thinkforward.work</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Using an insecure hostname
</div>
</div>
<div class="callout-body-container callout-body">
<p>For development purposes only, you can avoid registering a domain name and setting up certificates by using your local <code>hosts</code> file to redirect traffic later in this guide. If taking this route, you can use the following:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb82-1"><a href="#cb82-1"></a><span class="bu">export</span> <span class="va">HOSTNAME</span><span class="op">=</span>apps.gi.guardium-insights.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Run the following <code>ibm-pak</code> command to install the Foundational Services catalogs</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Private Registries for Catalog Sources
</div>
</div>
<div class="callout-body-container callout-body">
<p>This assumes you’ve mirrored all required GI and CPFS images to your private registry. Export your private registry as an env var (my.registry.io is an example.)</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb83-1"><a href="#cb83-1"></a><span class="bu">export</span> <span class="va">myprivatereg</span><span class="op">=</span>my.registry.io</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Set the following vars:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb84-1"><a href="#cb84-1"></a><span class="bu">export</span> <span class="va">ARGS</span><span class="op">=</span><span class="st">"--registry </span><span class="va">${myprivatereg}</span><span class="st"> --recursive --inputDir </span><span class="va">${LOCAL_CASE_DIR}</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Else set it to</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb85-1"><a href="#cb85-1"></a><span class="bu">export</span> <span class="va">ARGS</span><span class="op">=</span><span class="st">"--registry icr.io --recursive --inputDir </span><span class="va">${LOCAL_CASE_DIR}</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>:::caution<a href="#required-for-air-gapped-installations">Required for Air Gapped installations</a> You will need to install the <strong><a href="../../../guardium_insights/04_optional_services/#configure-security-constraints-optional">Gatekeeper OPA</a></strong> AND <strong><a href="../../../guardium_insights/04_optional_services/#configure-opa-mutations">configure mutations</a></strong> if using a private registry! :::</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb86-1"><a href="#cb86-1"></a><span class="ex">oc</span> ibm-pak launch <span class="va">$CASE_NAME</span> <span class="dt">\</span></span>
<span id="cb86-2"><a href="#cb86-2"></a>   <span class="at">--version</span> <span class="va">$CASE_VERSION</span> <span class="dt">\</span></span>
<span id="cb86-3"><a href="#cb86-3"></a>   <span class="at">--action</span> install-catalog <span class="dt">\</span></span>
<span id="cb86-4"><a href="#cb86-4"></a>   <span class="at">--inventory</span> <span class="va">$ICS_INVENTORY_SETUP</span> <span class="dt">\</span></span>
<span id="cb86-5"><a href="#cb86-5"></a>   <span class="at">--namespace</span> <span class="va">$NAMESPACE</span> <span class="dt">\</span></span>
<span id="cb86-6"><a href="#cb86-6"></a>   <span class="at">--args</span> <span class="st">"</span><span class="va">${ARGS}</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now run the following <code>ibm-pak</code> command to install the Foundational Services operators</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Private Registries for Foundational Services Operators
</div>
</div>
<div class="callout-body-container callout-body">
<p>This assumes you’ve mirrored all required GI and CPFS images to your private registry and exported the <code>$myprivatereg</code> as an env var.</p>
<p>Set the following vars:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb87-1"><a href="#cb87-1"></a><span class="bu">export</span> <span class="va">ARGS</span><span class="op">=</span><span class="st">"--size </span><span class="va">${ICS_SIZE}</span><span class="st"> --ks_flag true --hostname </span><span class="va">${HOSTNAME}</span><span class="st"> --registry </span><span class="va">${myprivatereg}</span><span class="st"> --user yourprivreguser --pass yourprivateregpass --secret yoursecretkey --recursive --inputDir </span><span class="va">${LOCAL_CASE_DIR}</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>omit <code>--user, --pass, --secret</code> if you did not set these on your private repo.</p>
<p>Else set it this to use the public and entitled registries:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb88-1"><a href="#cb88-1"></a><span class="bu">export</span> <span class="va">ARGS</span><span class="op">=</span><span class="st">"--size </span><span class="va">${ICS_SIZE}</span><span class="st"> --ks_flag true --hostname </span><span class="va">${HOSTNAME}</span><span class="st"> --registry cp.icr.io --user </span><span class="va">${CP_REPO_USER}</span><span class="st"> --pass </span><span class="va">${CP_REPO_PASS}</span><span class="st"> --secret ibm-entitlement-key --recursive --inputDir </span><span class="va">${LOCAL_CASE_DIR}</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Required for Air Gapped installations
</div>
</div>
<div class="callout-body-container callout-body">
<p>You will need to install the <strong><a href="../../../guardium_insights/04_optional_services/#configure-security-constraints-optional">Gatekeeper OPA</a></strong> AND <strong><a href="../../../guardium_insights/04_optional_services/#configure-opa-mutations">configure mutations</a></strong> if using a private registry!</p>
</div>
</div>
<div class="sourceCode" id="cb89"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb89-1"><a href="#cb89-1"></a><span class="ex">oc</span> ibm-pak launch <span class="va">$CASE_NAME</span> <span class="dt">\</span></span>
<span id="cb89-2"><a href="#cb89-2"></a>   <span class="at">--version</span> <span class="va">$CASE_VERSION</span> <span class="dt">\</span></span>
<span id="cb89-3"><a href="#cb89-3"></a>   <span class="at">--action</span> install-operator <span class="dt">\</span></span>
<span id="cb89-4"><a href="#cb89-4"></a>   <span class="at">--inventory</span> <span class="va">$ICS_INVENTORY_SETUP</span> <span class="dt">\</span></span>
<span id="cb89-5"><a href="#cb89-5"></a>   <span class="at">--namespace</span> <span class="va">$NAMESPACE</span> <span class="dt">\</span></span>
<span id="cb89-6"><a href="#cb89-6"></a>   <span class="at">--args</span> <span class="st">"</span><span class="va">$ARGS</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Airgapping CPFS extras
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you are performing an airgapped install, you must perform the following steps:</p>
<p>After kicking off the <code>install-operator</code> above, open another terminal and export your private registry as an env var (my.registry.io is an example).</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb90-1"><a href="#cb90-1"></a><span class="bu">export</span> <span class="va">myprivatereg</span><span class="op">=</span>my.registry.io</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now wait for the <code>cloud-native-postgreql-image-list</code> config map to be created.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb91-1"><a href="#cb91-1"></a><span class="ex">kubectl</span> get cm cloud-native-postgresql-image-list <span class="at">-w</span></span>
<span id="cb91-2"><a href="#cb91-2"></a></span>
<span id="cb91-3"><a href="#cb91-3"></a><span class="ex">NAME</span>                                 DATA   AGE</span>
<span id="cb91-4"><a href="#cb91-4"></a><span class="ex">cloud-native-postgresql-image-list</span>   6      25h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When it appears, run the following</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb92-1"><a href="#cb92-1"></a><span class="ex">kubectl</span> get cm cloud-native-postgresql-image-list <span class="at">-o</span> yaml <span class="kw">|</span> <span class="fu">sed</span> <span class="at">-E</span> <span class="st">"s/cp.icr.io|\bicr.io/</span><span class="va">$myprivatereg</span><span class="st">/"</span> <span class="op">&gt;</span> cloud-native-postgresql-image-list-patch.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then patch the config map.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb93-1"><a href="#cb93-1"></a><span class="ex">kubectl</span> patch cm cloud-native-postgresql-image-list <span class="at">--patch-file</span> cloud-native-postgresql-image-list-patch.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now wait for the <code>cloud-native-postgresql.v1.18.12</code> <code>ClusterServiceVersion</code> to be created</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb94-1"><a href="#cb94-1"></a><span class="ex">kubectl</span> get csv cloud-native-postgresql.v1.18.12 <span class="at">-w</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When it appears, run the following:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb95-1"><a href="#cb95-1"></a><span class="ex">kubectl</span> get csv cloud-native-postgresql.v1.18.12 <span class="at">-o</span> yaml <span class="kw">|</span> <span class="fu">egrep</span> <span class="at">-v</span> <span class="st">"generation:|resourceVersion:"</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="at">-E</span> <span class="st">"s/cp.icr.io|\bicr.io/</span><span class="va">$myprivatereg</span><span class="st">/"</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="at">-e</span> <span class="st">'/^status:/,$ d'</span> <span class="op">&gt;</span> cloud-native-postgresql.v1.18.12-patch.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Patch the CSV</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb96-1"><a href="#cb96-1"></a><span class="ex">kubectl</span> patch csv cloud-native-postgresql.v1.18.12 <span class="at">--type</span> merge <span class="at">--patch-file</span> cloud-native-postgresql.v1.18.12-patch.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now you can return to your previous terminal to wait for the installation to complete.</p>
</div>
</div>
<p>This may take a little while to run.</p>
<section id="verify-foundational-services-are-properly-installed" class="level3">
<h3 class="anchored" data-anchor-id="verify-foundational-services-are-properly-installed">Verify Foundational Services are properly installed</h3>
<div class="sourceCode" id="cb97"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb97-1"><a href="#cb97-1"></a><span class="ex">kubectl</span> get csv <span class="kw">|</span> <span class="fu">grep</span> ibm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output should look like this:</p>
<pre><code>ibm-cert-manager-operator.v4.2.11             IBM Cert Manager                       4.2.11                                          Succeeded
ibm-common-service-operator.v4.6.6            IBM Cloud Pak foundational services    4.6.6                                           Succeeded
ibm-commonui-operator.v4.4.5                  Ibm Common UI                          4.4.5                                           Succeeded
ibm-events-operator.v5.0.1                    IBM Events Operator                    5.0.1                                           Succeeded
ibm-iam-operator.v4.5.5                       IBM IM Operator                        4.5.5                                           Succeeded
ibm-zen-operator.v5.1.8                       IBM Zen Service                        5.1.8                                           Succeeded</code></pre>
</section>
<section id="verify-that-the-operand-requests-have-completed-and-installed" class="level3">
<h3 class="anchored">Verify that the operand requests have completed and installed</h3>
<div class="sourceCode" id="cb99"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb99-1"><a href="#cb99-1"></a><span class="ex">kubectl</span> get opreq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output should look like this:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb100-1"><a href="#cb100-1"></a><span class="ex">NAME</span>                          AGE     PHASE     CREATED AT</span>
<span id="cb100-2"><a href="#cb100-2"></a><span class="ex">common-service</span>                4m41s   Running   2024-10-14T20:21:04Z</span>
<span id="cb100-3"><a href="#cb100-3"></a><span class="ex">ibm-iam-request</span>               4m9s    Running   2024-10-14T20:21:36Z</span>
<span id="cb100-4"><a href="#cb100-4"></a><span class="ex">postgresql-operator-request</span>   4m8s    Running   2024-10-14T20:21:37Z</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Verify the policies have all been created</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb101-1"><a href="#cb101-1"></a><span class="ex">kubectl</span> get netpol</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output should look like this:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb102-1"><a href="#cb102-1"></a><span class="ex">NAME</span>                                     POD-SELECTOR                                     AGE</span>
<span id="cb102-2"><a href="#cb102-2"></a><span class="ex">access-to-audit-svc</span>                      component=zen-audit                              4m1s</span>
<span id="cb102-3"><a href="#cb102-3"></a><span class="ex">access-to-common-web-ui</span>                  k8s-app=common-web-ui                            4m19s</span>
<span id="cb102-4"><a href="#cb102-4"></a><span class="ex">access-to-edb-postgres</span>                   k8s.enterprisedb.io/cluster                      4m16s</span>
<span id="cb102-5"><a href="#cb102-5"></a><span class="ex">access-to-edb-postgres-webhooks</span>          app.kubernetes.io/name=cloud-native-postgresql   3m30s</span>
<span id="cb102-6"><a href="#cb102-6"></a><span class="ex">access-to-ibm-common-service-operator</span>    name=ibm-common-service-operator                 3m27s</span>
<span id="cb102-7"><a href="#cb102-7"></a><span class="ex">access-to-ibm-nginx</span>                      component=ibm-nginx                              3m58s</span>
<span id="cb102-8"><a href="#cb102-8"></a><span class="ex">access-to-icp-mongodb</span>                    app=icp-mongodb                                  4m13s</span>
<span id="cb102-9"><a href="#cb102-9"></a><span class="ex">access-to-platform-auth-service</span>          k8s-app=platform-auth-service                    4m10s</span>
<span id="cb102-10"><a href="#cb102-10"></a><span class="ex">access-to-platform-identity-management</span>   k8s-app=platform-identity-management             4m5s</span>
<span id="cb102-11"><a href="#cb102-11"></a><span class="ex">access-to-platform-identity-provider</span>     k8s-app=platform-identity-provider               4m3s</span>
<span id="cb102-12"><a href="#cb102-12"></a><span class="ex">access-to-usermgmt</span>                       component=usermgmt                               3m55s</span>
<span id="cb102-13"><a href="#cb102-13"></a><span class="ex">access-to-volumes</span>                        icpdsupport/app=volumes                          3m42s</span>
<span id="cb102-14"><a href="#cb102-14"></a><span class="ex">access-to-zen-core</span>                       component=zen-core                               3m50s</span>
<span id="cb102-15"><a href="#cb102-15"></a><span class="ex">access-to-zen-core-api</span>                   component=zen-core-api                           3m52s</span>
<span id="cb102-16"><a href="#cb102-16"></a><span class="ex">access-to-zen-meta-api</span>                   app.kubernetes.io/instance=ibm-zen-meta-api      3m24s</span>
<span id="cb102-17"><a href="#cb102-17"></a><span class="ex">access-to-zen-minio</span>                      component=zen-minio                              3m46s</span>
<span id="cb102-18"><a href="#cb102-18"></a><span class="ex">access-to-zen-watchdog</span>                   component=zen-watchdog                           3m39s</span>
<span id="cb102-19"><a href="#cb102-19"></a><span class="ex">allow-iam-config-job</span>                     component=iam-config-job                         3m34s</span>
<span id="cb102-20"><a href="#cb102-20"></a><span class="ex">allow-webhook-access-from-apiserver</span>      <span class="op">&lt;</span>none<span class="op">&gt;</span>                                           3m21s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Verify NGINX ingresses have been created</p>
<div class="hidden">
<p>{/*</p>
<section id="install-kubernetes-ingresses" class="level2">
<h2 class="anchored" data-anchor-id="install-kubernetes-ingresses">Install Kubernetes Ingresses</h2>
<p>Export the following values. As above, the example FQDN we are using is <code>apps.gi.thinkforward.work</code>. Yours may be different depending on what you’ve set in your DNS or Route 53.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb103-1"><a href="#cb103-1"></a><span class="bu">export</span> <span class="va">REPLACE_NAMESPACE</span><span class="op">=</span>openshift-marketplace</span>
<span id="cb103-2"><a href="#cb103-2"></a><span class="bu">export</span> <span class="va">HOSTNAME</span><span class="op">=</span>apps.gi.thinkforward.work</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Using an insecure hostname
</div>
</div>
<div class="callout-body-container callout-body">
<p>For development purposes only, you can avoid registering a domain name and setting up certificates by using your local <code>hosts</code> file to redirect traffic later in this guide. If taking this route, you can use the following:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb104-1"><a href="#cb104-1"></a><span class="bu">export</span> <span class="va">REPLACE_NAMESPACE</span><span class="op">=</span>openshift-marketplace</span>
<span id="cb104-2"><a href="#cb104-2"></a><span class="bu">export</span> <span class="va">HOSTNAME</span><span class="op">=</span>apps.gi.guardium-insights.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Run the Configmap creation with the following commands</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb105-1"><a href="#cb105-1"></a><span class="cf">while</span> <span class="kw">[[</span> <span class="va">$(</span><span class="ex">kubectl</span> get secret platform-oidc-credentials <span class="at">-ojsonpath</span><span class="op">=</span><span class="st">'{.data.WLP_CLIENT_SECRET}'</span> <span class="kw">|</span> <span class="fu">base64</span> <span class="at">-d</span> <span class="kw">|</span> <span class="fu">wc</span> <span class="at">-c</span><span class="va">)</span> <span class="ot">-eq</span> 0 <span class="kw">]]</span> <span class="kw">;</span> <span class="cf">do</span> <span class="bu">echo</span> Waiting 30 seconds for platform-oidc-credentials to be created with the correct content<span class="kw">;</span> <span class="fu">sleep</span> 30<span class="kw">;</span> <span class="cf">done</span></span>
<span id="cb105-2"><a href="#cb105-2"></a><span class="va">client_id</span><span class="op">=</span><span class="st">"</span><span class="va">$(</span><span class="ex">kubectl</span> get secret platform-oidc-credentials <span class="at">-o</span> yaml <span class="kw">|</span><span class="fu">grep</span> <span class="st">'WLP_CLIENT_ID:'</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">'s/WLP_CLIENT_ID: * //'</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">'{print $1}'</span><span class="va">)</span><span class="st">"</span></span>
<span id="cb105-3"><a href="#cb105-3"></a><span class="va">client_id</span><span class="op">=</span><span class="kw">`</span><span class="bu">echo</span> <span class="va">$client_id</span><span class="kw">|</span><span class="fu">base64</span> <span class="at">--decode</span><span class="kw">`</span></span>
<span id="cb105-4"><a href="#cb105-4"></a><span class="bu">echo</span> <span class="va">$client_id</span></span>
<span id="cb105-5"><a href="#cb105-5"></a></span>
<span id="cb105-6"><a href="#cb105-6"></a><span class="fu">cat</span> cpfs-ingress-template.yaml <span class="kw">|</span> <span class="fu">sed</span> <span class="st">'s#REPLACE_CLIENT_ID#'</span><span class="va">$client_id</span><span class="st">'#g'</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">'s#REPLACE_NAMESPACE#'</span><span class="va">$NAMESPACE</span><span class="st">'#g'</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">'s#REPLACE_HOSTNAME#'</span><span class="va">$HOSTNAME</span><span class="st">'#g'</span> <span class="kw">|</span> <span class="ex">kubectl</span> apply <span class="at">-f</span> <span class="at">-</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>*/}</p>
</section>
</div>
<p>Verify the ingress creation</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb106-1"><a href="#cb106-1"></a><span class="ex">kubectl</span> get ingress</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output should look like this:</p>
<pre><code>NAME                         CLASS   HOSTS                                                         ADDRESS                                                                               PORTS   AGE
cncf-common-web-ui           nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-id-mgmt                 nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-auth           nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-id-auth        nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-id-provider    nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-login          nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-oidc           nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-saml-ui-callback        nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-social-login-callback   nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s</code></pre>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Using an insecure hostname
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you used an insecure hostname above, configure your local workstation to redirect traffic to the external IP of the ingress.</p>
<p>Find the public hostname address of the ingress under <code>EXTERNAL-IP</code>.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb108-1"><a href="#cb108-1"></a><span class="ex">kubectl</span> get service <span class="at">--namespace</span> ingress-nginx ingress-nginx-controller</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>NAME                       TYPE           CLUSTER-IP      EXTERNAL-IP                                                                     PORT(S)                      AGE
ingress-nginx-controller   LoadBalancer   10.100.24.243   a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com   80:31369/TCP,443:30370/TCP   20h</code></pre>
<p>Find the public IP address of the of the public hostname.</p>
<pre><code>nslookup a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com
Server:         10.255.255.254
Address:        10.255.255.254#53

Non-authoritative answer:
Name:   a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com
Address: 13.58.11.46
Name:   a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com
Address: 3.19.41.78</code></pre>
<p>Notice that there are 2 public IP addresses associated with the hostname. This is because that hostname is on a load balancer. For our purposes, you only need one of those IP addresses. We will use <code>13.58.11.46</code> here.</p>
<p>Open your <code>hosts</code> file on your workstation where you will be using the browser to connect. For Windows that is under <code>C:\Windows\System32\drivers\etc\hosts</code>. For Linux that is under <code>/etc/hosts</code>.</p>
<p>Add a line that redirects network traffic from the insecure hostname to the public IP address and save the file.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb111-1"><a href="#cb111-1"></a><span class="ex">13.58.11.46</span>   cp-console-openshift-marketplace.apps.gi.guardium-insights.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After installing Guardium Insights (next step), another ingress will be created that will need to be added to the local hosts file. Add that additional line now, even though that hostname will not redirect properly until after Guardium Insights is installed.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb112-1"><a href="#cb112-1"></a><span class="ex">13.58.11.46</span>   guardium.apps.gi.guardium-insights.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="verify-ingress" class="level3">
<h3 class="anchored" data-anchor-id="verify-ingress">Verify Ingress</h3>
<p>Verify that the common webui is now up and available by going to the link above (this will reflect whatever you set for your domain). In our case it is <code>cp-console-openshift-marketplace.apps.gi.thinkforward.work</code></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Using an insecure hostname
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you used an insecure hostname above, use <code>cp-console-openshift-marketplace.apps.gi.guardium-insights.com</code> to verify.</p>
</div>
</div>
<p>You can retrieve the <code>cpadmin</code> password with the following</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb113-1"><a href="#cb113-1"></a><span class="ex">kubectl</span> get secret platform-auth-idp-credentials <span class="at">-o</span> jsonpath=<span class="st">'{.data.admin_password}'</span> <span class="kw">|</span> <span class="fu">base64</span> <span class="at">-d</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will return the password for the <code>cpadmin</code> user. You can then use <code>cpadmin</code> to login.</p>
<p><a href="../../../images/webui01.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="../../../images/webui01.png" class="img-fluid"></a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ibm-client-engineering\.github\.io\/solution-journal-quantum-safe\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../src/guardium_insights/eks/01_pre-reqs.html" class="pagination-link" aria-label="Prerequisites">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Prerequisites</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../src/guardium_insights/03_gi-install.html" class="pagination-link" aria-label="Guardium Insights Installation">
        <span class="nav-page-text">Guardium Insights Installation</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<div class="listitem">
<a href="https://ibm.com" rel="noopener noreferrer" class="footerLogo"><img src="https://www.ibm.com/brand/experience-guides/developer/8f4e3cc2b5d52354a6d43c8edba1e3c9/02_8-bar-reverse.svg" alt="IBM Logo" class="footer__logo themedComponent_node_modules-@docusaurus-theme-common-lib-components-ThemedComponent-styles-module themedComponent--light_node_modules-@docusaurus-theme-common-lib-components-ThemedComponent-styles-module" width="250" height="250"></a>
</div>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>