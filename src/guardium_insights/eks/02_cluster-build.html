<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Running Guardium Insights with QSPM on EKS">

<title>EKS Cluster build – IBM Quantum Safe Encryption</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../src/guardium_insights/03_gi-install.html" rel="next">
<link href="../../../src/guardium_insights/eks/01_pre-reqs.html" rel="prev">
<link href="../../../images/bee.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-24af2020e4147f07069e9e2e115d4586.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": true,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "Search",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../images/IBMlogo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">IBM Quantum Safe Encryption</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/ibm-client-engineering">
 <span class="dropdown-text">Check us out on Github</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ibm-client-engineering/solution-journal-quantum-safe">
 <span class="dropdown-text">Look at this repo on Github</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-linkedin" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-linkedin">    
        <li>
    <a class="dropdown-item" href="http://linkedin.com/post">
 <span class="dropdown-text">Share on your LinkedIn</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.linkedin.com/company/ibm/">
 <span class="dropdown-text">IBM LinkedIn</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Guardium Insights</li><li class="breadcrumb-item"><a href="../../../src/guardium_insights/eks/01_pre-reqs.html">EKS</a></li><li class="breadcrumb-item"><a href="../../../src/guardium_insights/eks/02_cluster-build.html">EKS Cluster Build</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Definition</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">QSR</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Adaptive Proxy</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qsr/adaptive_proxy/01_installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qsr/adaptive_proxy/02_configuration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configuration</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Performance Test Harness</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qsr/performance_test_harness/01_installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qsr/performance_test_harness/02_usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Usage</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">QSE</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qse/01_installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/qse/02_scanning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scanning</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Guardium Insights</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">EC2</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/ec2/01-prereqs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prerequisites</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/ec2/02-preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preparation</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">EKS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/eks/01_pre-reqs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prerequisites</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/eks/02_cluster-build.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">EKS Cluster Build</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/03_gi-install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Guardium Insights Installation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/guardium_insights/04_optional_services.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optional Services</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../src/key-takeaway.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Key Takeaways</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#creating-the-cluster" id="toc-creating-the-cluster" class="nav-link active" data-scroll-target="#creating-the-cluster">Creating the cluster</a></li>
  <li><a href="#configure-kubectl" id="toc-configure-kubectl" class="nav-link" data-scroll-target="#configure-kubectl">Configure <code>kubectl</code></a></li>
  <li><a href="#install-the-ebs-driver-to-the-cluster" id="toc-install-the-ebs-driver-to-the-cluster" class="nav-link" data-scroll-target="#install-the-ebs-driver-to-the-cluster">Install the EBS driver to the cluster</a>
  <ul class="collapse">
  <li><a href="#verifying-ebs" id="toc-verifying-ebs" class="nav-link" data-scroll-target="#verifying-ebs">Verifying EBS</a></li>
  </ul></li>
  <li><a href="#enable-efs-on-the-cluster" id="toc-enable-efs-on-the-cluster" class="nav-link" data-scroll-target="#enable-efs-on-the-cluster">Enable EFS on the cluster</a>
  <ul class="collapse">
  <li><a href="#create-iam-policy" id="toc-create-iam-policy" class="nav-link" data-scroll-target="#create-iam-policy">Create IAM policy</a></li>
  <li><a href="#create-iam-role" id="toc-create-iam-role" class="nav-link" data-scroll-target="#create-iam-role">Create IAM role</a></li>
  <li><a href="#install-efs-csi-driver" id="toc-install-efs-csi-driver" class="nav-link" data-scroll-target="#install-efs-csi-driver">Install EFS CSI driver</a></li>
  <li><a href="#create-the-efs-filesystem" id="toc-create-the-efs-filesystem" class="nav-link" data-scroll-target="#create-the-efs-filesystem">Create the EFS Filesystem</a></li>
  <li><a href="#create-efs-storage-class" id="toc-create-efs-storage-class" class="nav-link" data-scroll-target="#create-efs-storage-class">Create EFS Storage Class</a></li>
  <li><a href="#verify-efs" id="toc-verify-efs" class="nav-link" data-scroll-target="#verify-efs">Verify EFS</a></li>
  </ul></li>
  <li><a href="#install-nginx-controller" id="toc-install-nginx-controller" class="nav-link" data-scroll-target="#install-nginx-controller">Install NGINX Controller</a>
  <ul class="collapse">
  <li><a href="#verify-the-nginx-deployment" id="toc-verify-the-nginx-deployment" class="nav-link" data-scroll-target="#verify-the-nginx-deployment">Verify the NGINX deployment</a></li>
  </ul></li>
  <li><a href="#install-the-operator-lifecycle-manager" id="toc-install-the-operator-lifecycle-manager" class="nav-link" data-scroll-target="#install-the-operator-lifecycle-manager">Install the Operator Lifecycle Manager</a></li>
  <li><a href="#create-the-required-namespace" id="toc-create-the-required-namespace" class="nav-link" data-scroll-target="#create-the-required-namespace">Create the required Namespace</a></li>
  <li><a href="#install-the-ibm-cert-manager" id="toc-install-the-ibm-cert-manager" class="nav-link" data-scroll-target="#install-the-ibm-cert-manager">Install the IBM Cert Manager</a></li>
  <li><a href="#configure-dns-resolution-optional" id="toc-configure-dns-resolution-optional" class="nav-link" data-scroll-target="#configure-dns-resolution-optional">Configure DNS resolution (Optional)</a></li>
  <li><a href="#install-foundational-services" id="toc-install-foundational-services" class="nav-link" data-scroll-target="#install-foundational-services">Install Foundational Services</a>
  <ul class="collapse">
  <li><a href="#verify-foundational-services-are-properly-installed" id="toc-verify-foundational-services-are-properly-installed" class="nav-link" data-scroll-target="#verify-foundational-services-are-properly-installed">Verify Foundational Services are properly installed</a></li>
  <li><a href="#verify-that-the-operand-requests-have-completed-and-installed" id="toc-verify-that-the-operand-requests-have-completed-and-installed" class="nav-link" data-scroll-target="#verify-that-the-operand-requests-have-completed-and-installed">Verify that the operand requests have completed and installed</a></li>
  </ul></li>
  <li><a href="#install-network-policies-for-foundational-services" id="toc-install-network-policies-for-foundational-services" class="nav-link" data-scroll-target="#install-network-policies-for-foundational-services">Install network policies for Foundational Services</a></li>
  <li><a href="#install-kubernetes-ingresses" id="toc-install-kubernetes-ingresses" class="nav-link" data-scroll-target="#install-kubernetes-ingresses">Install Kubernetes Ingresses</a>
  <ul class="collapse">
  <li><a href="#verify-ingress" id="toc-verify-ingress" class="nav-link" data-scroll-target="#verify-ingress">Verify Ingress</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Guardium Insights</li><li class="breadcrumb-item"><a href="../../../src/guardium_insights/eks/01_pre-reqs.html">EKS</a></li><li class="breadcrumb-item"><a href="../../../src/guardium_insights/eks/02_cluster-build.html">EKS Cluster Build</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">EKS Cluster build</h1>
</div>

<div>
  <div class="description">
    Running Guardium Insights with QSPM on EKS
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>import { Tabs, TabItem } from ‘<span class="citation" data-cites="astrojs/starlight/components">@astrojs/starlight/components</span>’;</p>
<p>:::note[Useful Links]</p>
<p>Some of these steps come from this documentation for <a href="https://www.ibm.com/docs/en/guardium-insights/3.x?topic=scenarios-installation-amazon-elastic-kubernetes-service-eks">Guardium Insights on EKS</a></p>
<p>:::</p>
<div class="note">
<p>This assumes you have already configured <code>eksctl</code> and your aws configuration with your account info.</p>
<p>This also assumes you will be creating the cluster in the us-east region. This can be set to whatever region you want.</p>
</div>
<p>Run the <code>eksctl</code> command below to create your first cluster and perform the following:</p>
<ul>
<li>Create a 5-node Kubernetes cluster named <code>gi-east</code> with node type as <code>m6i.4xlarge</code> and region as <code>us-east-1</code>.</li>
<li>Control plane is managed by AWS EKS, so sizing for control plane nodes doesn’t apply.</li>
<li>Define a minimum of one node (<code>--nodes-min 5</code>) and a maximum of three-node (<code>--nodes-max 6</code>) for this node group managed by EKS.</li>
<li>Create a node group with the name <code>guardium-workers</code> and select a machine type for the <code>guardium-workers</code> node group.</li>
</ul>
<p>:::caution[Multiple AZ support] As of this writing, GI v3.5.0 does not officially support multiple availability zones. This is due to the fact that DB2 will not run across multiple availability zones. The rest of the product will run across zones but because DB2 will not, true availability will not be achieved with multiple availability zones. :::</p>
<section id="creating-the-cluster" class="level2">
<h2 class="anchored" data-anchor-id="creating-the-cluster">Creating the cluster</h2>
<p>Let’s set some env vars to make our lives easier. :::note[On cluster names]</p>
<p>We’re deploying in <code>us-east-1</code> and we are naming our cluster <code>gi-east</code>. This name will be exclusive to this cluster, so <code>gi-east</code> is an example here. You aren’t bound to using <code>gi-east</code> as your name.</p>
<p>:::</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">clustername</span><span class="op">=</span>gi-east</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">region</span><span class="op">=</span>us-east-1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="tsx"><code>eksctl create cluster \
--name ${clustername} \
--version 1.31 \
--region ${region} \
--zones ${region}a,${region}b \
--nodegroup-name guardium-workers \
--node-type m6i.4xlarge \
--with-oidc \
--nodes 5 \
--nodes-min 5 \
--nodes-max 6 \
--node-zones ${region}a \
--tags "Product=Guardium" \
--managed</code></pre>
<p>Associate an IAM oidc provider with the cluster if you didn’t include <code>--with-oidc</code> above.</p>
<pre class="tsx"><code>eksctl utils associate-iam-oidc-provider --region=${region} --cluster=${clustername} --approve</code></pre>
</section>
<section id="configure-kubectl" class="level2">
<h2 class="anchored" data-anchor-id="configure-kubectl">Configure <code>kubectl</code></h2>
<p>Once the cluster is up, add it to your kube config. <code>eksctl</code> will probably do this for you.</p>
<pre class="tsx"><code>aws eks update-kubeconfig --name ${clustername} --region ${region}</code></pre>
<p>{/* ### Create the EKS Pod Identity Agent Addon</p>
<p>We’re going to use the EKS pod identity management addon to as IRSA (IAM Roles for Service Accounts) is deprecated and Pod Identity Management requires less permissions for a user who may not have IAM privileges.</p>
<pre class="tsx"><code>eksctl create addon \
--name eks-pod-identity-agent \
--cluster ${clustername} \
--region ${region} \
--version latest</code></pre>
<p>Let’s verify the addon was created</p>
<pre class="tsx"><code>eksctl get addon --cluster ${clustername} --region ${region} --name eks-pod-identity-agent -o json </code></pre>
<p>Should return something like this</p>
<pre class="tsx"><code>2024-08-23 12:09:50 [ℹ]  Kubernetes version "1.30" in use by cluster "gi-east"
2024-08-23 12:09:51 [ℹ]  to see issues for an addon run `eksctl get addon --name &lt;addon-name&gt; --cluster &lt;cluster-name&gt;`
[
    {
        "Name": "eks-pod-identity-agent",
        "Version": "v1.3.0-eksbuild.1",
        "NewerVersion": "",
        "IAMRole": "",
        "Status": "ACTIVE",
        "ConfigurationValues": "",
        "Issues": null,
        "PodIdentityAssociations": null
    }
]</code></pre>
<p>*/}</p>
<p>:::note[Deploying Optional OPA Security Constraints]</p>
<p>If you plan to use the Gatekeeper OPA on your cluster, follow the instructions <a href="../04_optional_services/#configure-security-constraints-optional">here</a></p>
<p>:::</p>
</section>
<section id="install-the-ebs-driver-to-the-cluster" class="level2">
<h2 class="anchored" data-anchor-id="install-the-ebs-driver-to-the-cluster">Install the EBS driver to the cluster</h2>
<p>We install the EBS CSI driver as this gives us access to GP3 block storage.</p>
<p>Download the example ebs iam policy</p>
<pre class="tsx"><code>curl -o iam-policy-example-ebs.json https://raw.githubusercontent.com/kubernetes-sigs/aws-ebs-csi-driver/master/docs/example-iam-policy.json</code></pre>
<p>Create the policy. You can change <code>AmazonEKS_EBS_CSI_Driver_Policy</code> to a different name, but if you do, make sure to change it in later steps too.</p>
<pre class="tsx"><code>aws iam create-policy \
--policy-name AmazonEKS_EBS_CSI_Driver_Policy \
--tags '{"Key": "Product","Value": "Guardium"}' \
--policy-document file://iam-policy-example-ebs.json</code></pre>
<p>Output should be similar to below</p>
<pre class="tsx"><code>{
    "Policy": {
        "PolicyName": "AmazonEKS_EBS_CSI_Driver_Policy",
        "PolicyId": "ANPA24LVTCGN5YOUAVX2V",
        "Arn": "arn:aws:iam::&lt;ACCOUNT ID&gt;:policy/AmazonEKS_EBS_CSI_Driver_Policy",
        "Path": "/",
        "DefaultVersionId": "v1",
        "AttachmentCount": 0,
        "PermissionsBoundaryUsageCount": 0,
        "IsAttachable": true,
        "CreateDate": "2023-04-19T14:17:03+00:00",
        "UpdateDate": "2023-04-19T14:17:03+00:00",
        "Tags": [
            {
                "Key": "Product",
                "Value": "Guardium"
            }
        ]
    }
}

</code></pre>
<p>Let’s export the returned arn as a env VAR for further use</p>
<pre class="tsx"><code>export ebs_driver_policy_arn=$(aws iam list-policies --query 'Policies[?PolicyName==`AmazonEKS_EBS_CSI_Driver_Policy`].Arn' --output text)</code></pre>
<p>Now let’s export the rolename we are going to create as a env var. We’re going to append the cluster name to the role to differentiate in case we have multiple clusters in this account. You can share policies, but you cannot share roles.</p>
<pre class="tsx"><code>export ebs_driver_role_name=AmazonEKS_EBS_CSI_DriverRole-${clustername}</code></pre>
<p>Create the service account</p>
<pre class="tsx"><code>eksctl create iamserviceaccount \
  --name ebs-csi-controller-sa \
  --namespace kube-system \
  --cluster ${clustername} \
  --attach-policy-arn $ebs_driver_policy_arn \
  --approve \
  --region=${region} \
  --tags "Product=Guardium" \
  --role-only \
  --role-name ${ebs_driver_role_name}</code></pre>
<p>Let’s export the created role arn as another env var</p>
<pre class="tsx"><code>export ebs_driver_role_arn=$(aws iam list-roles --query 'Roles[?RoleName==`AmazonEKS_EBS_CSI_DriverRole-'$clustername'`].Arn' --output text)</code></pre>
<p>Create the addon for the cluster</p>
<pre class="tsx"><code>eksctl create addon \
--name aws-ebs-csi-driver \
--cluster ${clustername} \
--service-account-role-arn $ebs_driver_role_arn \
--region=${region} \
--force</code></pre>
<p>Create the following StorageClass yaml to use gp3</p>
<pre class="tsx"><code>cat &lt;&lt;EOF |kubectl apply -f -
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ebs-gp3-sc
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  fsType: ext4
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
EOF</code></pre>
<section id="verifying-ebs" class="level3">
<h3 class="anchored" data-anchor-id="verifying-ebs">Verifying EBS</h3>
<p>Run the following command</p>
<pre class="tsx"><code>kubectl apply -f - &lt;&lt;EOF 
apiVersion: v1 
kind: PersistentVolumeClaim 
metadata: 
  name: block-pvc 
spec: 
  storageClassName: ebs-gp3-sc
  accessModes: 
    - ReadWriteOnce 
  resources: 
    requests: 
      storage: 1Gi 
--- 
apiVersion: v1 
kind: Pod 
metadata: 
  name: mypod 
spec: 
  containers: 
    - name: myfrontend 
      image: nginx 
      volumeMounts: 
        - mountPath: "/var/www/html" 
          name: mypd 
  volumes: 
    - name: mypd 
      persistentVolumeClaim: 
        claimName: block-pvc 
EOF</code></pre>
<p>Verify the PVC was created</p>
<pre class="tsx"><code>kubectl get pvc
NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
block-pvc   Bound    pvc-67193212-3e10-46ab-a0a4-2834e3560c4a   1Gi        RWO            ebs-gp3-sc     &lt;unset&gt;                 7s</code></pre>
<p>You should see the bound status of the above pvc.</p>
<p>Delete the test pod and pvc</p>
<pre class="tsx"><code>kubectl delete -f - &lt;&lt;EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: block-pvc
spec:
  storageClassName: ebs-gp3-sc
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: mypod
spec:
  containers:
    - name: myfrontend
      image: nginx
      volumeMounts:
        - mountPath: "/var/www/html"
          name: mypd
  volumes:
    - name: mypd
      persistentVolumeClaim:
        claimName: block-pvc
EOF</code></pre>
</section>
</section>
<section id="enable-efs-on-the-cluster" class="level2">
<h2 class="anchored" data-anchor-id="enable-efs-on-the-cluster">Enable EFS on the cluster</h2>
<p>By default when we create a cluster with eksctl it defines and installs <code>gp2</code> storage class which is backed by Amazon’s EBS (elastic block storage). After that we installed the EBS CSI driver to support <code>gp3</code>. However, both <code>gp2</code> and <code>gp3</code> are both block storage. They will not support RWX in our cluster. We need to install an EFS storage class.</p>
<section id="create-iam-policy" class="level3">
<h3 class="anchored" data-anchor-id="create-iam-policy">Create IAM policy</h3>
<p>Download the IAM policy document from GitHub. You can also view the <a href="https://github.com/kubernetes-sigs/aws-efs-csi-driver/blob/master/docs/iam-policy-example.json">policy document</a></p>
<pre class="tsx"><code>curl -o iam-policy-example-efs.json https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/docs/iam-policy-example.json</code></pre>
<p>Create the policy. You can change <code>AmazonEKS_EFS_CSI_Driver_Policy</code> to a different name, but if you do, make sure to change it in later steps too.</p>
<pre class="tsx"><code>aws iam create-policy \
--policy-name AmazonEKS_EFS_CSI_Driver_Policy \
--tags '{"Key": "Product","Value": "Guardium"}' \
--policy-document file://iam-policy-example-efs.json</code></pre>
<p>Output should be similar to below</p>
<pre class="tsx"><code>{
    "Policy": {
        "PolicyName": "AmazonEKS_EFS_CSI_Driver_Policy",
        "PolicyId": "ANPA3WENOYSA6LSFRSZ6U",
        "Arn": "arn:aws:iam::803455550593:policy/AmazonEKS_EFS_CSI_Driver_Policy",
        "Path": "/",
        "DefaultVersionId": "v1",
        "AttachmentCount": 0,
        "PermissionsBoundaryUsageCount": 0,
        "IsAttachable": true,
        "CreateDate": "2024-08-23T19:57:13+00:00",
        "UpdateDate": "2024-08-23T19:57:13+00:00",
        "Tags": [
            {
                "Key": "Product",
                "Value": "Guardium"
            }
        ]
    }
}</code></pre>
<p>Let’s export that policy arn as another env var</p>
<pre class="tsx"><code>export efs_driver_policy_arn=$(aws iam list-policies --query 'Policies[?PolicyName==`AmazonEKS_EFS_CSI_Driver_Policy`].Arn' --output text)</code></pre>
</section>
<section id="create-iam-role" class="level3">
<h3 class="anchored" data-anchor-id="create-iam-role">Create IAM role</h3>
<p>Now let’s export the rolename we are going to create as a env var. We’re going to append the cluster name to the role to differentiate in case we have multiple clusters in this account. You can share policies, but you cannot share roles.</p>
<pre class="tsx"><code>export efs_driver_role_name=AmazonEKS_EFS_CSI_DriverRole-${clustername}</code></pre>
<p>Create an IAM role and attach the IAM policy to it. Annotate the Kubernetes service account with the IAM role ARN and the IAM role with the Kubernetes service account name.</p>
<pre class="tsx"><code>eksctl create iamserviceaccount \
    --cluster ${clustername} \
    --namespace kube-system \
    --name efs-csi-controller-sa \
    --role-name ${efs_driver_role_name} \
    --attach-policy-arn $efs_driver_policy_arn \
    --tags "Product=Guardium" \
    --approve \
    --region ${region}</code></pre>
<p>Once created, check the iam service account is created running the following command.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">eksctl</span> get iamserviceaccount <span class="at">--cluster</span> <span class="va">${clustername}</span> <span class="at">--region</span> <span class="va">${region}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Should return</p>
<pre class="tsx"><code>NAMESPACE   NAME            ROLE ARN
kube-system ebs-csi-controller-sa   arn:aws:iam::803455550593:role/AmazonEKS_EBS_CSI_DriverRole
kube-system efs-csi-controller-sa   arn:aws:iam::803455550593:role/AmazonEKS_EFS_CSI_DriverRole</code></pre>
</section>
<section id="install-efs-csi-driver" class="level3">
<h3 class="anchored" data-anchor-id="install-efs-csi-driver">Install EFS CSI driver</h3>
<p>Now we just need our add-on registry address. This can be found here: https://docs.aws.amazon.com/eks/latest/userguide/add-ons-images.html</p>
<div class="note">
<p>The add-on registry address is per region. So based on the URL above, since our region is <code>us-east-1</code>, then our registry address would be <code>602401143452.dkr.ecr.us-east-1.amazonaws.com/eks/aws-efs-csi-driver</code></p>
</div>
<p>Let’s install the driver add-on to our clusters. We’re going to use <code>helm</code> for this.</p>
<pre class="tsx"><code>helm repo add aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver/

helm repo update</code></pre>
<p>Install a release of the driver using the Helm chart. Replace the repository address with the cluster’s <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-ons-images.html">container image address</a>.</p>
<pre class="tsx"><code>helm upgrade -i aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver \
    --namespace kube-system \
    --set image.repository=602401143452.dkr.ecr.us-east-1.amazonaws.com/eks/aws-efs-csi-driver \
    --set controller.serviceAccount.create=false \
    --set controller.serviceAccount.name=efs-csi-controller-sa
</code></pre>
<p>Verify that it installed correctly with this command</p>
<pre class="tsx"><code>kubectl get pod -n kube-system -l "app.kubernetes.io/name=aws-efs-csi-driver,app.kubernetes.io/instance=aws-efs-csi-driver"</code></pre>
<p>Should return something like</p>
<pre class="tsx"><code>NAME                                  READY   STATUS    RESTARTS   AGE
efs-csi-controller-7fc77768fc-2swkw   3/3     Running   0          2m13s
efs-csi-controller-7fc77768fc-c69rb   3/3     Running   0          2m13s
efs-csi-node-ccxns                    3/3     Running   0          2d17h
efs-csi-node-k52pt                    3/3     Running   0          2d17h
efs-csi-node-r8nbm                    3/3     Running   0          2d17h</code></pre>
</section>
<section id="create-the-efs-filesystem" class="level3">
<h3 class="anchored" data-anchor-id="create-the-efs-filesystem">Create the EFS Filesystem</h3>
<p>Now we need to create the filesystem in EFS so we can use it</p>
<p>Export the following variables.</p>
<p>Get our VPC ID</p>
<pre class="tsx"><code>vpc_id=$(aws eks describe-cluster \
    --name $clustername \
    --query "cluster.resourcesVpcConfig.vpcId" \
    --region $region \
    --output text)</code></pre>
<p>Retrieve the CIDR range for your cluster’s VPC and store it in a variable for use in a later step.</p>
<pre class="tsx"><code>cidr_range=$(aws ec2 describe-vpcs \
    --vpc-ids $vpc_id \
    --query "Vpcs[].CidrBlock" \
    --output text \
    --region $region)</code></pre>
<p>Create a security group with an inbound rule that allows inbound NFS traffic for your Amazon EFS mount points.</p>
<pre class="tsx"><code>security_group_id=$(aws ec2 create-security-group \
    --group-name EFS4FileNetSecurityGroup-${clustername} \
    --description "EFS security group for Guardium Insight cluster ${clustername}" \
    --vpc-id $vpc_id \
    --region $region \
    --output text)</code></pre>
<p>Create an inbound rule that allows inbound NFS traffic from the CIDR for your cluster’s VPC.</p>
<pre class="tsx"><code>aws ec2 authorize-security-group-ingress \
    --group-id $security_group_id \
    --protocol tcp \
    --port 2049 \
    --region $region \
    --cidr $cidr_range</code></pre>
<p>Create a file system.</p>
<pre class="tsx"><code>file_system_id=$(aws efs create-file-system \
    --region $region \
    --encrypted \
    --tags '{"Key": "Product","Value": "Guardium"}' \
    --performance-mode generalPurpose \
    --query 'FileSystemId' \
    --output text)</code></pre>
<p>Create mount targets.</p>
<p>Determine the IDs of the subnets in your VPC and which Availability Zone the subnet is in.</p>
<pre class="tsx"><code>aws ec2 describe-subnets \
    --filters "Name=vpc-id,Values=$vpc_id" \
    --query 'Subnets[*].{SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock}' \
    --region $region \
    --output table</code></pre>
<p>Should output something like the following</p>
<pre class="tsx"><code>----------------------------------------------------------------------
|                           DescribeSubnets                          |
+------------------+--------------------+----------------------------+
| AvailabilityZone |     CidrBlock      |         SubnetId           |
+------------------+--------------------+----------------------------+
|  us-east-1c      |  192.168.64.0/19   |  subnet-08c33dce5e63c82dc  |
|  us-east-1b      |  192.168.32.0/19   |  subnet-0f7a2b449320cc1e6  |
|  us-east-1a      |  192.168.0.0/19    |  subnet-0ec499ae3eae19eb0  |
|  us-east-1b      |  192.168.128.0/19  |  subnet-04f3d465138687333  |
|  us-east-1a      |  192.168.96.0/19   |  subnet-0bc4d31344c60c113  |
|  us-east-1c      |  192.168.160.0/19  |  subnet-0bee6fc06187cafd1  |
+------------------+--------------------+----------------------------+</code></pre>
<p>Add mount targets for the subnets that your nodes are in.</p>
<p>Run the following command:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> subnet <span class="kw">in</span> <span class="va">$(</span><span class="ex">aws</span> ec2 describe-subnets <span class="at">--filters</span> <span class="st">"Name=vpc-id,Values=</span><span class="va">$vpc_id</span><span class="st">"</span> <span class="at">--query</span> <span class="st">'Subnets[*].{SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock}'</span> <span class="at">--region</span> <span class="va">$region</span> <span class="at">--output</span> text <span class="kw">|</span> <span class="fu">awk</span> <span class="st">'{print $3}'</span><span class="va">)</span> <span class="kw">;</span> <span class="cf">do</span> <span class="ex">aws</span> efs create-mount-target <span class="at">--file-system-id</span> <span class="va">$file_system_id</span> <span class="at">--region</span> <span class="va">$region</span> <span class="at">--subnet-id</span> <span class="va">$subnet</span> <span class="at">--security-groups</span> <span class="va">$security_group_id</span> <span class="kw">;</span> <span class="cf">done</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This wraps the below command in a for loop that will iterate through your subnet ids.</p>
<pre class="tsx"><code>aws efs create-mount-target \
    --file-system-id $file_system_id \
    --region $region \
    --subnet-id &lt;SUBNETID&gt; \
    --security-groups $security_group_id</code></pre>
</section>
<section id="create-efs-storage-class" class="level3">
<h3 class="anchored" data-anchor-id="create-efs-storage-class">Create EFS Storage Class</h3>
<p>Create a storage class for dynamic provisioning</p>
<p>Let’s get our filesystem ID if we don’t already have it above. However if you ran the above steps, <code>$file_system_id</code> should already be defined.</p>
<pre class="tsx"><code>aws efs describe-file-systems \
--query "FileSystems[*].FileSystemId" \
--region $region \
--output text

fs-071439ffb7e10b67b</code></pre>
<p>{/* Download a <code>StorageClass</code> manifest for Amazon EFS.</p>
<pre class="tsx"><code>curl -o EFSStorageClass.yaml https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/examples/kubernetes/dynamic_provisioning/specs/storageclass.yaml
</code></pre>
<p>*/}</p>
<p>:::note[Super Important!]</p>
<p>If you did not export the <code>$file_system_id</code> variable, make sure the filesystem id you use in the below command is the filesystem id that was returned to you above!</p>
<p>{/* You can retrieve the file system id with the following command:</p>
<pre class="tsx"><code></code></pre>
<p>Also if you are going to use EFS as your default storage, follow the instructions below. Otherwise just create the <code>efs-sc</code> storage class and skip the <code>efs-sc-pg</code> storage class as we will set the default to the gp3 block storage. */}</p>
<p>:::</p>
<p>Create the storage class</p>
<pre class="tsx"><code>cat &lt;&lt;EOF | envsubst | kubectl apply -f -
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: efs-sc
parameters:
  uid: "0"
  gid: "0"
  directoryPerms: "777"
  fileSystemId: ${file_system_id}
  provisioningMode: efs-ap
provisioner: efs.csi.aws.com
reclaimPolicy: Delete
volumeBindingMode: Immediate
EOF</code></pre>
<p>{/* Create this second storageclasses for EFS for common-services operator that will be installed as part of IBM Foundational Services. You will only need this second storage class if you intend on using EFS instead of block storage.</p>
<pre class="tsx"><code>cat &lt;&lt;EOF | envsubst | kubectl apply -f -
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: efs-sc-pg
parameters:
  uid: "26"
  gid: "65534"
  directoryPerms: "777"
  fileSystemId: ${file_system_id}
  provisioningMode: efs-ap
provisioner: efs.csi.aws.com
reclaimPolicy: Delete
volumeBindingMode: Immediate
EOF</code></pre>
<p>Update it with the storage class id as well as the following vars</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/fileSystemId:.*\/fileSystemId: </span><span class="va">$file_system_id</span><span class="st">/"</span> EFSStorageClass.yaml</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"s/directoryPerms:.*\/directoryPerms: </span><span class="dt">\"</span><span class="st">777</span><span class="dt">\"</span><span class="st">/"</span> EFSStorageClass.yaml</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"/basePath:.*\/d"</span> EFSStorageClass.yaml</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">"/parameters:/a\  gid: </span><span class="dt">\"</span><span class="st">0</span><span class="dt">\"</span><span class="st">\n  uid: </span><span class="dt">\"</span><span class="st">0</span><span class="dt">\"</span><span class="st">"</span> EFSStorageClass.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>*/}</p>
<p>{/* If using the default <code>sed</code> command that comes with MacOS</p>
<p>Deploy the storage class.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> EFSStorageClass.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>*/}</p>
<p>:::note[Setting Default Storage Class] Set one of the EFS storage classes as the default storage class only if you intend on primarily using EFS. Otherwise set block storage as default.</p>
<p>If using EFS as primary storage</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> patch storageclass efs-sc <span class="at">-p</span> <span class="st">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If using EBS(block) as primary storage</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> patch storageclass ebs-gp3-sc <span class="at">-p</span> <span class="st">'{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:::</p>
<p>Finally, verify they are both there</p>
<pre class="tsx"><code>kubectl get sc
NAME               PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
ebs-gp3-sc         ebs.csi.aws.com         Delete          WaitForFirstConsumer   false                  6d18h
efs-sc (default)   efs.csi.aws.com         Delete          Immediate              false                  16h
gp2                kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  6d23h</code></pre>
</section>
<section id="verify-efs" class="level3">
<h3 class="anchored" data-anchor-id="verify-efs">Verify EFS</h3>
<p>Run the following command to create a pod and a PVC using the default EFS storage class</p>
<pre class="tsx"><code>kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: block-pvc
spec:
  storageClassName: efs-sc
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: mypod
spec:
  containers:
    - name: myfrontend
      image: nginx
      volumeMounts:
        - mountPath: "/var/www/html"
          name: mypd
  volumes:
    - name: mypd
      persistentVolumeClaim:
        claimName: block-pvc
EOF</code></pre>
<p>Running the following command should verify the PVC was successfully created and bound</p>
<pre class="tsx"><code>kubectl get pvc</code></pre>
<pre class="tsx[output]"><code>NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
block-pvc   Bound    pvc-dc711246-02a1-4a9d-b428-a2476b17dd8c   1Gi        RWO            efs-sc         &lt;unset&gt;                 4s</code></pre>
<p>Now we can delete our test pod and pvc</p>
<pre class="tsx"><code>kubectl delete -f - &lt;&lt;EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: block-pvc
spec:
  storageClassName: efs-sc
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: mypod
spec:
  containers:
    - name: myfrontend
      image: nginx
      volumeMounts:
        - mountPath: "/var/www/html"
          name: mypd
  volumes:
    - name: mypd
      persistentVolumeClaim:
        claimName: block-pvc
EOF</code></pre>
</section>
</section>
<section id="install-nginx-controller" class="level2">
<h2 class="anchored" data-anchor-id="install-nginx-controller">Install NGINX Controller</h2>
<p>{/**/} :::note[On Ingresses]</p>
<p>If you plan on using AWS ALB for ingress, follow the directions <a href="../../../guardium_insights/04_optional_services/#optional-install-the-alb-ingress-controller">here</a></p>
<p>::: Let’s install the NGINX helm chart</p>
<pre class="tsx"><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update</code></pre>
<p>{/* Modify the NGINX controller deployment file</p>
<p>Pull down the NGINX controller deployment</p>
<pre><code>wget -O nginx-deploy.yaml https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/aws/deploy.yaml</code></pre>
<p>Export our relevant subnet ids to a comma delimited env variable</p>
<pre class="tsx"><code>export subnets=$(aws eks describe-cluster --name ${clustername} --region ${region} --query "cluster.resourcesVpcConfig.subnetIds" --output json | jq -r 'join(",")' | sed s/,/\\\\,/g)</code></pre>
<p>*/}</p>
<p>Create the namespace for NGINX</p>
<pre class="tsx"><code>kubectl create ns ingress-nginx</code></pre>
<p>{/* Export our relevant subnet ids to a comma delimited env variable</p>
<pre class="tsx"><code>export subnets=$(aws eks describe-cluster --name ${clustername} --region ${region} --query "cluster.resourcesVpcConfig.subnetIds" --output json | jq -r 'join(",")' | sed s/,/\\\\,/g)</code></pre>
<p>Now install the helm chart for nginx */}</p>
<p>{/<em>–set-string controller.service.annotations.’service.beta.kubernetes.io/aws-load-balancer-subnets’=“$subnets” &nbsp;</em>/}</p>
<p>:::note[Public vs Private ingress]</p>
<p>Below is for a public facing ingress. Yours might need to be internal only so you would set the <code>aws-load-balancer-scheme</code> to <code>internal</code> if it needs to be internal.</p>
<p>:::</p>
<pre class="tsx"><code>helm install ingress-nginx ingress-nginx/ingress-nginx \
--set-string controller.service.annotations.'service\.beta\.kubernetes\.io/aws-load-balancer-backend-protocol'=tcp \
--set-string controller.service.annotations.'service\.beta\.kubernetes\.io/aws-load-balancer-cross-zone-load-balancing-enabled'="true" \
--set-string controller.service.annotations.'service\.beta\.kubernetes\.io/aws-load-balancer-scheme'=internet-facing \
--set-string controller.service.annotations."service\.beta\.kubernetes\.io/aws-load-balancer-nlb-target-type"=ip \
--set-string controller.service.annotations.'service\.beta\.kubernetes\.io/aws-load-balancer-type'=nlb \
--namespace=ingress-nginx
</code></pre>
<p>Run the following command to verify that a load balancer was assigned</p>
<pre class="tsx"><code>kubectl get service --namespace ingress-nginx ingress-nginx-controller</code></pre>
<pre class="tsx[output]"><code>NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP                                                                     PORT(S)                      AGE
ingress-nginx-controller   LoadBalancer   10.100.204.215   a904f47d90a8c4961ae389b155359368-aa0f265b8588c710.elb.us-east-1.amazonaws.com   80:30870/TCP,443:31883/TCP   61s</code></pre>
<p>{/*</p>
<pre class="tsx"><code>sed "/    service.beta.kubernetes.io\/aws-load-balancer-type: nlb/a\    service.beta.kubernetes.io\/aws-load-balancer-subnets: \"$subnets\"" nginx-deploy.yaml</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Modify the deployment file by adding the annotations that do not exist and editing the one(s) that do:</p>
<pre class="tsx"><code>service.beta.kubernetes.io/aws-load-balancer-type: "external" // set this to "internal" if not using a public ip
service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "instance"
service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"</code></pre>
<p>Also search for the following configmap entry in the deployment file:</p>
<pre class="tsx"><code>---
apiVersion: v1
data:
  allow-snippet-annotations: "false"
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.9.1
  name: ingress-nginx-controller
  namespace: ingress-nginx
---</code></pre>
<p>We want to add the following annotations:</p>
<pre class="tsx"><code>allow-snippet-annotations: "true"
enable-underscores-in-headers: "true"
nginx.ingress.kubernetes.io/proxy-body-size: "0"</code></pre>
<p>So now our config map should look like this</p>
<pre class="tsx"><code>---
apiVersion: v1
data:
  allow-snippet-annotations: "false"
kind: ConfigMap
metadata:
  annotations:
    allow-snippet-annotations: "true"
    enable-underscores-in-headers: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "0" 
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.9.1
  name: ingress-nginx-controller
  namespace: ingress-nginx
---</code></pre>
<p>Now apply the deployment</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> nginx-deploy.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>*/}</p>
<section id="verify-the-nginx-deployment" class="level3">
<h3 class="anchored" data-anchor-id="verify-the-nginx-deployment">Verify the NGINX deployment</h3>
<p>Verify the deployment</p>
<p>Command:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get ingressclass</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Example output:</p>
<pre class="tsx"><code>NAME    CONTROLLER             PARAMETERS   AGE
nginx   k8s.io/ingress-nginx   &lt;none&gt;       2m43s</code></pre>
<p>{/* Once created, check the iam service account is created running the following command.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="ex">eksctl</span> get iamserviceaccount <span class="at">--cluster</span> <span class="op">&lt;</span>cluster-name<span class="op">&gt;</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="ex">NAMESPACE</span>   NAME                ROLE ARN</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="ex">kube-system</span> aws-load-balancer-controller    arn:aws:iam::748107796891:role/AmazonEKSLoadBalancerControllerRole</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="ex">kube-system</span> efs-csi-controller-sa       arn:aws:iam::748107796891:role/eksctl-filenet-cluster-east-addon-iamserviceaccount-ku-Role1-1SCBRU1DS52QY</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>*/}</p>
</section>
</section>
<section id="install-the-operator-lifecycle-manager" class="level2">
<h2 class="anchored" data-anchor-id="install-the-operator-lifecycle-manager">Install the Operator Lifecycle Manager</h2>
<p>:::note[Permissions for OLM] The default method of installing OLM is to use the <code>operator-sdk</code> command line tool. This method creates <code>ClusterRole</code> and <code>ClusterRoleBinding</code> resources that require wildcard permissions at the cluster level.</p>
<p>If the security on your cluster is configured to not allow wildcard permissions at the cluster level, proceed with the “Custom OLM” section below to install OLM without wildcard permissions.</p>
<p>:::</p>
<p><tabs synckey="OLM"> <tabitem label="operator-sdk"></tabitem></tabs></p>
<p>Run the following command using the <code>operator-sdk</code></p>
<pre class="tsx"><code>operator-sdk olm install</code></pre>
<p> <tabitem label="Custom OLM"></tabitem></p>
<p>Download (Save link as…) the customized <a href="https://ibm-client-engineering.github.io/engineering-journal-quantum-safe/olm/crds.yaml">crds.yaml</a> and <a href="https://ibm-client-engineering.github.io/engineering-journal-quantum-safe/olm/olm.yaml">olm.yaml</a> for OLM v0.28.0. Keep in mind, this is a point in time customization for GI 3.5.0 and OLM v0.28.0.</p>
<p>Create the CRDs</p>
<pre><code>kubectl create -f crds.yaml</code></pre>
<p>Ensure that CRDs were applied.</p>
<pre><code>kubectl wait --for=condition=Established -f crds.yaml</code></pre>
<p>Create the OLM resources</p>
<pre><code>kubectl create -f olm.yaml</code></pre>
<p>Wait for deployments to be ready.</p>
<pre><code>kubectl rollout status -w deployment/olm-operator --namespace="olm"
kubectl rollout status -w deployment/catalog-operator --namespace="olm"</code></pre>
<p> </p>
<hr>
<p>Verify the installation</p>
<pre><code>kubectl get csv -n olm | grep packageserver</code></pre>
<pre class="tsx[output]"><code>packageserver   Package Server   0.28.0               Succeeded</code></pre>
<p>Set the OLM global namespade to use openshift-marketplace</p>
<pre class="tsx"><code>oc set env deploy/catalog-operator GLOBAL_CATALOG_NAMESPACE=openshift-marketplace -n olm</code></pre>
<p>We further require to change the global namespace for the packageserver as well. To do so, run the following command:</p>
<pre class="tsx"><code>kubectl patch csv packageserver -n olm --type='json' -p='[
  {
    "op": "replace",
    "path": "/spec/install/spec/deployments/0/spec/template/spec/containers/0/command/5",
    "value": "openshift-marketplace"
  }
]'</code></pre>
<p>Verify the global-namespace has been set</p>
<pre class="tsx"><code>kubectl get deploy packageserver -n olm -o yaml | grep -A 6 "command:"</code></pre>
<p>Should return</p>
<p><code>tsx {7}       - command:         - /bin/package-server         - -v=4         - --secure-port         - "5443"         - --global-namespace         - openshift-marketplace</code></p>
</section>
<section id="create-the-required-namespace" class="level2">
<h2 class="anchored" data-anchor-id="create-the-required-namespace">Create the required Namespace</h2>
<pre class="tsx"><code>kubectl create ns openshift-marketplace</code></pre>
<p>Set our context to that namespace and export it as an env var</p>
<pre class="tsx"><code>export NAMESPACE=openshift-marketplace

kubectl config set-context --current --namespace $NAMESPACE</code></pre>
</section>
<section id="install-the-ibm-cert-manager" class="level2">
<h2 class="anchored" data-anchor-id="install-the-ibm-cert-manager">Install the IBM Cert Manager</h2>
<p>:::note[On Cert Managers]</p>
<p>If you cannot use the IBM Cert Manager, follow the directions <a href="../../../guardium_insights/04_optional_services/#installing-community-cert-manager">here</a> :::</p>
<p>If you followed the directions <a href="../01_pre-reqs/#downloading-the-case-file">here</a> you should have the <code>ibm-guardium-insights</code> case file downloaded and extracted.</p>
<p>Change to the following directory</p>
<pre class="tsx"><code>cd ibm-guardium-data-security-center/inventory/install/files/support/eks</code></pre>
<p>Create the namespace and then run the installation script</p>
<pre class="tsx"><code>kubectl create namespace ibm-cert-manager
chmod +x ibm-cert-manager.sh
./ibm-cert-manager.sh</code></pre>
<p>{/<em>If you need to limit the cert manager to a single namespace, edit the <code>ibm-cert-manager.sh</code> script.</em>/}</p>
<p>Give it a few minutes and then verify the cert manager is up</p>
<pre class="tsx"><code>kubectl get po -n ibm-cert-manager</code></pre>
<pre class="tsx"><code>NAME                                                              READY   STATUS      RESTARTS   AGE
cd6e1c2b84458a4f431f49f499a919d28af0b23693e36f2fc53bc1f2c3hw5pw   0/1     Completed   0          2m1s
cert-manager-cainjector-85777f77cc-hbzg7                          1/1     Running     0          102s
cert-manager-controller-957bc947-kg5wx                            1/1     Running     0          102s
cert-manager-webhook-5586d798f-lcsln                              1/1     Running     0          102s
ibm-cert-manager-catalog-rcbvc                                    1/1     Running     0          2m12s
ibm-cert-manager-operator-64fc5b4644-rnpqg                        1/1     Running     0          108s</code></pre>
<pre class="tsx"><code>kubectl get csv -n ibm-cert-manager</code></pre>
<pre><code>NAME                               DISPLAY            VERSION   REPLACES   PHASE
ibm-cert-manager-operator.v4.2.7   IBM Cert Manager   4.2.7                Succeeded</code></pre>
<p>{/*</p>
<p>:::note[Deploying with ACM] If you plan to use AWS ACM to manage your certs with an ALB ingress, follow the install instructions <a href="../04_optional_services/#use-aws-ca-acm-for-certs-optional">here</a> ::: */}</p>
</section>
<section id="configure-dns-resolution-optional" class="level2">
<h2 class="anchored" data-anchor-id="configure-dns-resolution-optional">Configure DNS resolution (Optional)</h2>
<p>If you are following the instrutions in this guide using the “insecure” hostname sections to avoid registering domains, it’s possible to use Route 53 in AWS set up explicit DNS resolution for the specific host routes needed.</p>
<p>Go to <a href="https://console.aws.amazon.com/route53/">AWS Route 53</a> and click <code>Hosted zones</code> heading. Then click the <code>Create hosted zone</code> button. This will open the hosted zone form.</p>
<p>For the domain use</p>
<pre><code>apps.gi.guardium-insights.com</code></pre>
<p>For type, select <code>Private hosted zone</code></p>
<p>For the VPCs to associate with the hosted zone, select the proper region, then select the VPC that was created for your cluster.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/user-attachments/assets/676c77ba-abb0-43e5-9313-d1efaed23dcb.png" class="img-fluid figure-img"></p>
<figcaption>843816c6-ced2-4b4c-a554-89903338a4b1</figcaption>
</figure>
</div>
<p>Then click <code>Create Hosted zone</code> button to create the hosted zone.</p>
<p>This will take you to the hosted zone details page. Now it’s time to create some records for DNS resolution. But first we need the values to use for the internal routing.</p>
<p>Find the external cluster IP address of the load balancer under <code>EXTERNAL-IP</code>.</p>
<pre class="tsx"><code>kubectl get service --namespace ingress-nginx ingress-nginx-controller</code></pre>
<pre class="tsx"><code>NAME                       TYPE           CLUSTER-IP      EXTERNAL-IP                                                                     PORT(S)                      AGE
ingress-nginx-controller   LoadBalancer   10.100.24.243   a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com   80:31369/TCP,443:30370/TCP   20h</code></pre>
<p>Capture that <code>EXTERNAL-IP</code> value for the next steps.</p>
<p>Back on the hosted zone details page, click the <code>Create record</code> button.</p>
<p>We want to create a <code>CNAME</code> record that routes <code>*.apps.gi.guardium-insights.com</code> to the external cluster IP address captured above.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://private-user-images.githubusercontent.com/137658020/396157933-da3edef3-9a47-47fd-bb9c-c386406ec48c.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzQzNzg0MTksIm5iZiI6MTczNDM3ODExOSwicGF0aCI6Ii8xMzc2NTgwMjAvMzk2MTU3OTMzLWRhM2VkZWYzLTlhNDctNDdmZC1iYjljLWMzODY0MDZlYzQ4Yy5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjQxMjE2JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI0MTIxNlQxOTQxNTlaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1mMTc3ZjhjNGNhZWU0Y2MwZmRhZDRhMDhhMTQzYzJmMzJlNDVhMTRhYjI3YTU1NTA2ZTk5YzliODZhYzI0ZGIwJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.M1n79fF4eXHtd6j05ZGneCYN1SQkUJS-WS8TiDY61Us" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<p>Click <code>Create Records</code>.</p>
</section>
<section id="install-foundational-services" class="level2">
<h2 class="anchored" data-anchor-id="install-foundational-services">Install Foundational Services</h2>
<div class="note[Entitlement]">
<p>As noted <a href="../guardium_insights/01_pre-reqs/">here</a> make sure you have retrieved your entitlement key for the next step</p>
</div>
<p>Export your entitlement key as an env var</p>
<pre><code>export IBMKEY="&lt;entitlement key&gt;"</code></pre>
<p>Change to the following directory</p>
<pre class="tsx"><code>cd ibm-guardium-data-security-center/inventory/install/files/support/eks</code></pre>
<p>As of this writing, we are using Guardium Data Security center v3.6.0 which uses bundle version 2.6.0.</p>
<p>Export the following vars</p>
<pre class="tsx"><code>export REPLACE_NAMESPACE=openshift-marketplace
export NAMESPACE=openshift-marketplace
export ICS_INVENTORY_SETUP=ibmCommonServiceOperatorSetup
export ICS_SIZE=starterset
export IBMPAK_LAUNCH_SKIP_PREREQ_CHECK=true
export CP_REPO_USER="cp"
export CP_REPO_PASS=${IBMKEY}
export NAMESPACE="openshift-marketplace"
export CASE_NAME=ibm-guardium-data-security-center
export CASE_VERSION=2.6.0
export LOCAL_CASE_DIR=$HOME/.ibm-pak/data/cases/$CASE_NAME/$CASE_VERSION</code></pre>
<p>Save the CASE bundle locally</p>
<pre class="tsx"><code>oc ibm-pak get $CASE_NAME \
--version $CASE_VERSION \
--skip-verify</code></pre>
<p>This will download the CASE bundle to <code>$HOME/.ibm-pak/data/cases/ibm-guardium-data-security-center/2.6.0</code></p>
<p>{/<em>We’re going to use the loadbalancer name for this as we aren’t using any DNS (hope it works)</em>/}</p>
<p>:::note[On DNS] Whether you’re using Route 53 or external DNS, a CNAME must be created if you’re using NGINX as your Ingress Controller.</p>
<p>For our example setup, we are working with the <code>thinkforward.work</code> domain. So we set the domain in our remote dns to <code>apps.gi.thinkforward.work</code>. Other users may need to configure their FQDN in AWS Route 53.</p>
<p>The important part is there must be a wildcard subdomain. It should point to our loadbalancer.</p>
<p>Retrieve the loadbalancer ip with this command:</p>
<pre class="tsx"><code>kubectl get service --namespace ingress-nginx ingress-nginx-controller</code></pre>
<p>Should return <code>tsx {2} NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP                                                                     PORT(S)                      AGE ingress-nginx-controller   LoadBalancer   10.100.129.192   k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com   80:32113/TCP,443:31457/TCP   24h</code></p>
<p>Our external IP above is <code>k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com</code></p>
<p>So for us, our actual DNS record should be like this:</p>
<pre class="tsx"><code>CNAME    *.gi-east.apps.thinkforward.work  -&gt;  k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com</code></pre>
<p>The <code>*</code> wildcard ensures that any subdomain generated by GI will map back to that loadbalancer.</p>
<p>:::</p>
<p>Export the hostname as an env var. It’s important to note that your domain must begin with <code>apps</code>. If you have multiple clusters, a good practices would be <code>apps.&lt;CLUSTERNAME&gt;.&lt;DOMAIN&gt;</code>.</p>
<pre class="tsx"><code>export HOSTNAME=apps.gi.thinkforward.work</code></pre>
<p>:::note[Using an insecure hostname] For development purposes only, you can avoid registering a domain name and setting up certificates by using your local <code>hosts</code> file to redirect traffic later in this guide. If taking this route, you can use the following:</p>
<pre class="tsx"><code>export HOSTNAME=apps.gi.guardium-insights.com</code></pre>
<p>::: {/* :::note[On Storageclasses]</p>
<p>Make the following modifications to the <code>CPFS-install-template.sh</code> ONLY if you are using the custom EFS storage class instead of block storage.</p>
<p>Open the CPFS-install-template.sh in an editor and locate the following code block</p>
<pre class="tsx"><code>operand_request=$(cat &lt;&lt;EOF
apiVersion: operator.ibm.com/v1alpha1
kind: OperandRequest
metadata:
  name: common-service
  namespace: $NAMESPACE
spec:
  requests:
    - operands:
        - name: ibm-im-operator
        - name: ibm-platformui-operator
        - name: cloud-native-postgresql
        - name: ibm-events-operator
      registry: common-service
      registryNamespace: $NAMESPACE
EOF
)</code></pre>
<p>Insert the following line just before that code block</p>
<pre class="tsx"><code>sleep 30
kubectl patch --type=merge commonservice common-service -p '{"spec": {"storageClass":"efs-sc-pg"}}'</code></pre>
<p>Now it should look like the following</p>
<pre class="tsx"><code>sleep 30
kubectl patch --type=merge commonservice common-service -p '{"spec": {"storageClass":"efs-sc-pg"}}'

operand_request=$(cat &lt;&lt;EOF
apiVersion: operator.ibm.com/v1alpha1
kind: OperandRequest
metadata:
  name: common-service
  namespace: $NAMESPACE
spec:
  requests:
    - operands:
        - name: ibm-im-operator
        - name: ibm-platformui-operator
        - name: cloud-native-postgresql
        - name: ibm-events-operator
      registry: common-service
      registryNamespace: $NAMESPACE
EOF
)</code></pre>
<p>We’re adding the <code>sleep 30</code> so the common-services CR will become available ::: ### Run the CPFS install script</p>
<pre class="tsx"><code>chmod +x CPFS-install-template.sh
./CPFS-install-template.sh</code></pre>
<p>If you see the following error out, re-run the command <code>tsx {10-11} No resources found in openshift-marketplace namespace. operatorgroup.operators.coreos.com/operatorgroup created configmap/ibm-cpp-config created catalogsource.operators.coreos.com/opencloud-operators created catalogsource.operators.coreos.com/cloud-native-postgresql-catalog created subscription.operators.coreos.com/ibm-common-service-operator created Validate the installation Waiting for CRD commonservices.operator.ibm.com to be created in namespace openshift-marketplace... Attempt 1/5 CRD commonservices.operator.ibm.com exists. error: resource mapping not found for name: "common-service" namespace: "openshift-marketplace" from "STDIN": no matches for kind "OperandRequest" in version "operator.ibm.com/v1alpha1" ensure CRDs are installed first</code></p>
<p>Re-run should return</p>
<pre class="tsx"><code>OperatorGroup already exists in namespace openshift-marketplace.
configmap/ibm-cpp-config configured
catalogsource.operators.coreos.com/opencloud-operators unchanged
catalogsource.operators.coreos.com/cloud-native-postgresql-catalog unchanged
subscription.operators.coreos.com/ibm-common-service-operator unchanged
Validate the installation
CRD commonservices.operator.ibm.com exists.
operandrequest.operator.ibm.com/common-service unchanged</code></pre>
<p>*/}</p>
<p>Run the following <code>ibm-pak</code> command to install the Foundational Services catalogs</p>
<p>:::note[Private Registries for Catalog Sources]</p>
<p>This assumes you’ve mirrored all required GI and CPFS images to your private registry. Export your private registry as an env var (my.registry.io is an example.)</p>
<pre class="tsx"><code>export myprivatereg=my.registry.io</code></pre>
<p>Set the following vars:</p>
<pre class="tsx"><code>export ARGS="--registry ${myprivatereg} --recursive --inputDir ${LOCAL_CASE_DIR}"</code></pre>
<p>Else set it to</p>
<pre class="tsx"><code>export ARGS="--registry icr.io --recursive --inputDir ${LOCAL_CASE_DIR}"</code></pre>
<p>:::</p>
<p>:::caution[Required for Air Gapped installations] You will need to install the <strong><a href="../../../guardium_insights/04_optional_services/#configure-security-constraints-optional">Gatekeeper OPA</a></strong> AND <strong><a href="../../../guardium_insights/04_optional_services/#configure-opa-mutations">configure mutations</a></strong> if using a private registry! :::</p>
<pre class="tsx"><code>oc ibm-pak launch $CASE_NAME \
   --version $CASE_VERSION \
   --action install-catalog \
   --inventory $ICS_INVENTORY_SETUP \
   --namespace $NAMESPACE \
   --args "${ARGS}"</code></pre>
<p>{/* Let’s patch the commonservices cr to accept the license</p>
<pre class="tsx"><code>kubectl patch commonservices common-service --type merge -p '{"spec":{"license":{"accept":true}}}'</code></pre>
<p>*/} Now run the following <code>ibm-pak</code> command to install the Foundational Services operators</p>
<p>:::note[Private Registries for Foundational Services Operators]</p>
<p>This assumes you’ve mirrored all required GI and CPFS images to your private registry and exported the <code>$myprivatereg</code> as an env var.</p>
<p>Set the following vars:</p>
<pre class="tsx"><code>export ARGS="--size ${ICS_SIZE} --ks_flag true --hostname ${HOSTNAME} --registry ${myprivatereg} --user yourprivreguser --pass yourprivateregpass --secret yoursecretkey --recursive --inputDir ${LOCAL_CASE_DIR}"</code></pre>
<p>omit <code>--user, --pass, --secret</code> if you did not set these on your private repo.</p>
<p>Else set it this to use the public and entitled registries:</p>
<pre class="tsx"><code>export ARGS="--size ${ICS_SIZE} --ks_flag true --hostname ${HOSTNAME} --registry cp.icr.io --user ${CP_REPO_USER} --pass ${CP_REPO_PASS} --secret ibm-entitlement-key --recursive --inputDir ${LOCAL_CASE_DIR}"</code></pre>
<p>:::</p>
<p>:::caution[Required for Air Gapped installations] You will need to install the <strong><a href="../../../guardium_insights/04_optional_services/#configure-security-constraints-optional">Gatekeeper OPA</a></strong> AND <strong><a href="../../../guardium_insights/04_optional_services/#configure-opa-mutations">configure mutations</a></strong> if using a private registry! :::</p>
<pre class="tsx"><code>oc ibm-pak launch $CASE_NAME \
   --version $CASE_VERSION \
   --action install-operator \
   --inventory $ICS_INVENTORY_SETUP \
   --namespace $NAMESPACE \
   --args "$ARGS"</code></pre>
<p>:::note[Airgapping CPFS extras]</p>
<p>If you are performing an airgapped install, you must perform the following steps:</p>
<p>After kicking off the <code>install-operator</code> above, open another terminal and export your private registry as an env var (my.registry.io is an example).</p>
<pre class="tsx"><code>export myprivatereg=my.registry.io</code></pre>
<p>Now wait for the <code>cloud-native-postgreql-image-list</code> config map to be created.</p>
<pre class="tsx"><code>kubectl get cm cloud-native-postgresql-image-list -w

NAME                                 DATA   AGE
cloud-native-postgresql-image-list   6      25h</code></pre>
<p>When it appears, run the following</p>
<pre class="tsx"><code>kubectl get cm cloud-native-postgresql-image-list -o yaml | sed -E "s/cp.icr.io|\bicr.io/$myprivatereg/" &gt; cloud-native-postgresql-image-list-patch.yaml</code></pre>
<p>Then patch the config map.</p>
<pre class="tsx"><code>kubectl patch cm cloud-native-postgresql-image-list --patch-file cloud-native-postgresql-image-list-patch.yaml</code></pre>
<p>Now wait for the <code>cloud-native-postgresql.v1.18.12</code> <code>ClusterServiceVersion</code> to be created</p>
<pre class="tsx"><code>kubectl get csv cloud-native-postgresql.v1.18.12 -w</code></pre>
<p>When it appears, run the following:</p>
<pre class="tsx"><code>kubectl get csv cloud-native-postgresql.v1.18.12 -o yaml | egrep -v "generation:|resourceVersion:" | sed -E "s/cp.icr.io|\bicr.io/$myprivatereg/" | sed -e '/^status:/,$ d' &gt; cloud-native-postgresql.v1.18.12-patch.yaml</code></pre>
<p>Patch the CSV</p>
<pre class="tsx"><code>kubectl patch csv cloud-native-postgresql.v1.18.12 --type merge --patch-file cloud-native-postgresql.v1.18.12-patch.yaml</code></pre>
<p>Now you can return to your previous terminal to wait for the installation to complete.</p>
<p>:::</p>
<p>This may take a little while to run.</p>
<p>{/*</p>
<pre class="tsx"><code>kubectl get pvc
NAME                      STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
common-service-db-1       Bound     pvc-adb72a84-4a21-4b6b-91bd-3b3969ea3a99   10Gi       RWO            efs-sc         &lt;unset&gt;                 2m50s
common-service-db-1-wal   Pending                                                                        efs-sc         &lt;unset&gt;                 2m50s</code></pre>
<p>It seems the path name was too long. We adjusted it by removing the path directive from the storage class */}</p>
<p>{/*</p>
<p>Getting the uid/gid for postgres (for the storage class)</p>
<pre class="tsx"><code>kubectl describe clusters.postgresql.k8s.enterprisedb.io common-service-db | egrep "UID|GID"</code></pre>
<p>Should return a bunch of stuff, but we want this</p>
<pre class="tsx"><code>  UID:                 1cd7dd91-bf67-4fbe-8967-44323dad3b55
  Postgres GID:               26
  Postgres UID:               26</code></pre>
<p>So questions….</p>
<ul>
<li>How do we specify the storage class for this instead of depending on whatever is set to default?</li>
</ul>
<p>We updated the efs-sc storage class by deleting it, adding the uid of 26 and setting gid to 65534 and reapplying it.</p>
<p>Now we are testing the deployment again.</p>
<p>BANG IT WORKS</p>
<p>Things to check on</p>
<p>Updating the common-service-db CR to use a specific storage class</p>
<p>*/}</p>
<section id="verify-foundational-services-are-properly-installed" class="level3">
<h3 class="anchored" data-anchor-id="verify-foundational-services-are-properly-installed">Verify Foundational Services are properly installed</h3>
<pre class="tsx"><code>kubectl get csv | grep ibm</code></pre>
<p>Output should look like this:</p>
<pre><code>ibm-cert-manager-operator.v4.2.11             IBM Cert Manager                       4.2.11                                          Succeeded
ibm-common-service-operator.v4.6.6            IBM Cloud Pak foundational services    4.6.6                                           Succeeded
ibm-commonui-operator.v4.4.5                  Ibm Common UI                          4.4.5                                           Succeeded
ibm-events-operator.v5.0.1                    IBM Events Operator                    5.0.1                                           Succeeded
ibm-iam-operator.v4.5.5                       IBM IM Operator                        4.5.5                                           Succeeded
ibm-zen-operator.v5.1.8                       IBM Zen Service                        5.1.8                                           Succeeded</code></pre>
</section>
<section id="verify-that-the-operand-requests-have-completed-and-installed" class="level3">
<h3 class="anchored" data-anchor-id="verify-that-the-operand-requests-have-completed-and-installed">Verify that the operand requests have completed and installed</h3>
<pre class="tsx"><code>kubectl get opreq</code></pre>
<p>Output should look like this:</p>
<pre class="tsx"><code>NAME                          AGE     PHASE     CREATED AT
common-service                4m41s   Running   2024-10-14T20:21:04Z
ibm-iam-request               4m9s    Running   2024-10-14T20:21:36Z
postgresql-operator-request   4m8s    Running   2024-10-14T20:21:37Z</code></pre>
<p>{/* ### Patch the common-service CR to accept the license</p>
<pre class="tsx"><code>kubectl patch commonservices common-service --type merge -p '{"spec":{"license":{"accept":true}}}'</code></pre>
</section>
</section>
<section id="install-network-policies-for-foundational-services" class="level2">
<h2 class="anchored" data-anchor-id="install-network-policies-for-foundational-services">Install network policies for Foundational Services</h2>
<pre class="tsx"><code>export CS_NAMESPACE=openshift-marketplace
cp -R ibm-guardium-data-security-center/inventory/ibmCommonServiceOperatorSetup/files/cp3-networkpolicy/ingress ibm-guardium-data-security-center/inventory/install/files/support/eks/
./install_networkpolicy.sh -n $CS_NAMESPACE</code></pre>
<p>*/}</p>
<p>Verify the policies have all been created</p>
<pre class="tsx"><code>kubectl get netpol</code></pre>
<p>Output should look like this:</p>
<pre class="tsx"><code>NAME                                     POD-SELECTOR                                     AGE
access-to-audit-svc                      component=zen-audit                              4m1s
access-to-common-web-ui                  k8s-app=common-web-ui                            4m19s
access-to-edb-postgres                   k8s.enterprisedb.io/cluster                      4m16s
access-to-edb-postgres-webhooks          app.kubernetes.io/name=cloud-native-postgresql   3m30s
access-to-ibm-common-service-operator    name=ibm-common-service-operator                 3m27s
access-to-ibm-nginx                      component=ibm-nginx                              3m58s
access-to-icp-mongodb                    app=icp-mongodb                                  4m13s
access-to-platform-auth-service          k8s-app=platform-auth-service                    4m10s
access-to-platform-identity-management   k8s-app=platform-identity-management             4m5s
access-to-platform-identity-provider     k8s-app=platform-identity-provider               4m3s
access-to-usermgmt                       component=usermgmt                               3m55s
access-to-volumes                        icpdsupport/app=volumes                          3m42s
access-to-zen-core                       component=zen-core                               3m50s
access-to-zen-core-api                   component=zen-core-api                           3m52s
access-to-zen-meta-api                   app.kubernetes.io/instance=ibm-zen-meta-api      3m24s
access-to-zen-minio                      component=zen-minio                              3m46s
access-to-zen-watchdog                   component=zen-watchdog                           3m39s
allow-iam-config-job                     component=iam-config-job                         3m34s
allow-webhook-access-from-apiserver      &lt;none&gt;                                           3m21s</code></pre>
<p>Verify NGINX ingresses have been created {/*</p>
</section>
<section id="install-kubernetes-ingresses" class="level2">
<h2 class="anchored" data-anchor-id="install-kubernetes-ingresses">Install Kubernetes Ingresses</h2>
<p>Export the following values. As above, the example FQDN we are using is <code>apps.gi.thinkforward.work</code>. Yours may be different depending on what you’ve set in your DNS or Route 53.</p>
<pre class="tsx"><code>export REPLACE_NAMESPACE=openshift-marketplace
export HOSTNAME=apps.gi.thinkforward.work</code></pre>
<p>:::note[Using an insecure hostname] For development purposes only, you can avoid registering a domain name and setting up certificates by using your local <code>hosts</code> file to redirect traffic later in this guide. If taking this route, you can use the following:</p>
<pre class="tsx"><code>export REPLACE_NAMESPACE=openshift-marketplace
export HOSTNAME=apps.gi.guardium-insights.com</code></pre>
<p>:::</p>
<p>Run the Configmap creation with the following commands</p>
<pre class="tsx"><code>while [[ $(kubectl get secret platform-oidc-credentials -ojsonpath='{.data.WLP_CLIENT_SECRET}' | base64 -d | wc -c) -eq 0 ]] ; do echo Waiting 30 seconds for platform-oidc-credentials to be created with the correct content; sleep 30; done
client_id="$(kubectl get secret platform-oidc-credentials -o yaml |grep 'WLP_CLIENT_ID:' | sed 's/WLP_CLIENT_ID: * //' | awk '{print $1}')"
client_id=`echo $client_id|base64 --decode`
echo $client_id

cat cpfs-ingress-template.yaml | sed 's#REPLACE_CLIENT_ID#'$client_id'#g' | sed 's#REPLACE_NAMESPACE#'$NAMESPACE'#g' | sed 's#REPLACE_HOSTNAME#'$HOSTNAME'#g' | kubectl apply -f -</code></pre>
<p>*/}</p>
<p>Verify the ingress creation</p>
<pre class="tsx"><code>kubectl get ingress</code></pre>
<p>Output should look like this:</p>
<pre class="tsx"><code>NAME                         CLASS   HOSTS                                                         ADDRESS                                                                               PORTS   AGE
cncf-common-web-ui           nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-id-mgmt                 nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-auth           nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-id-auth        nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-id-provider    nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-login          nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-platform-oidc           nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-saml-ui-callback        nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s
cncf-social-login-callback   nginx   cp-console-openshift-marketplace.apps.gi.thinkforward.work    k8s-ingressn-ingressn-7e06ec0c6b-01363c775f8b7ff9.elb.us-east-1.amazonaws.com         80      13s</code></pre>
<p>:::note[Using an insecure hostname] If you used an insecure hostname above, configure your local workstation to redirect traffic to the external IP of the ingress.</p>
<p>Find the public hostname address of the ingress under <code>EXTERNAL-IP</code>.</p>
<pre class="tsx"><code>kubectl get service --namespace ingress-nginx ingress-nginx-controller</code></pre>
<pre class="tsx"><code>NAME                       TYPE           CLUSTER-IP      EXTERNAL-IP                                                                     PORT(S)                      AGE
ingress-nginx-controller   LoadBalancer   10.100.24.243   a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com   80:31369/TCP,443:30370/TCP   20h</code></pre>
<p>Find the public IP address of the of the public hostname.</p>
<pre class="tsx"><code>nslookup a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com
Server:         10.255.255.254
Address:        10.255.255.254#53

Non-authoritative answer:
Name:   a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com
Address: 13.58.11.46
Name:   a091398910dbf4ad8aeb2f3f0e864311-916cbf853e32c1d5.elb.us-east-2.amazonaws.com
Address: 3.19.41.78</code></pre>
<p>Notice that there are 2 public IP addresses associated with the hostname. This is because that hostname is on a load balancer. For our purposes, you only need one of those IP addresses. We will use <code>13.58.11.46</code> here.</p>
<p>Open your <code>hosts</code> file on your workstation where you will be using the browser to connect. For Windows that is under <code>C:\Windows\System32\drivers\etc\hosts</code>. For Linux that is under <code>/etc/hosts</code>.</p>
<p>Add a line that redirects network traffic from the insecure hostname to the public IP address and save the file.</p>
<pre class="tsx"><code>13.58.11.46   cp-console-openshift-marketplace.apps.gi.guardium-insights.com</code></pre>
<p>After installing Guardium Insights (next step), another ingress will be created that will need to be added to the local hosts file. Add that additional line now, even though that hostname will not redirect properly until after Guardium Insights is installed.</p>
<pre class="tsx"><code>13.58.11.46   guardium.apps.gi.guardium-insights.com</code></pre>
<p>:::</p>
<section id="verify-ingress" class="level3">
<h3 class="anchored" data-anchor-id="verify-ingress">Verify Ingress</h3>
<p>Verify that the common webui is now up and available by going to the link above (this will reflect whatever you set for your domain). In our case it is <code>cp-console-openshift-marketplace.apps.gi.thinkforward.work</code></p>
<p>:::note[Using an insecure hostname] If you used an insecure hostname above, use <code>cp-console-openshift-marketplace.apps.gi.guardium-insights.com</code> to verify.</p>
<p>:::</p>
<p>You can retrieve the <code>cpadmin</code> password with the following</p>
<pre class="tsx"><code>kubectl get secret platform-auth-idp-credentials -o jsonpath='{.data.admin_password}' | base64 -d</code></pre>
<p>This will return the password for the <code>cpadmin</code> user. You can then use <code>cpadmin</code> to login.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../../../assets/images/webui01.png" class="img-fluid figure-img"></p>
<figcaption>Webui</figcaption>
</figure>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ibm-client-engineering\.github\.io\/solution-journal-quantum-safe\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../src/guardium_insights/eks/01_pre-reqs.html" class="pagination-link" aria-label="Prerequisites">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Prerequisites</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../src/guardium_insights/03_gi-install.html" class="pagination-link" aria-label="Guardium Insights Installation">
        <span class="nav-page-text">Guardium Insights Installation</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<div class="listitem">
<a href="https://ibm.com" rel="noopener noreferrer" class="footerLogo"><img src="https://www.ibm.com/brand/experience-guides/developer/8f4e3cc2b5d52354a6d43c8edba1e3c9/02_8-bar-reverse.svg" alt="IBM Logo" class="footer__logo themedComponent_node_modules-@docusaurus-theme-common-lib-components-ThemedComponent-styles-module themedComponent--light_node_modules-@docusaurus-theme-common-lib-components-ThemedComponent-styles-module" width="250" height="250"></a>
</div>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>